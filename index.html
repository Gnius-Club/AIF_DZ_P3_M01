<!DOCTYPE html>
<html lang="es" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0b1023" />
<title>El Arque√≥logo del Tiempo Digital: Ecos del Futuro</title>
<link rel="manifest" href="data:application/manifest+json,{\"name\":\"Ecos del Futuro\",\"short_name\":\"Ecos\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#0b1023\",\"theme_color\":\"#0b1023\"}" />
<style>
  :root{
    --bg:#0b1023; /* noche */
    --bg2:#162550;
    --accent:#39e6ff;
    --accent2:#57ff7a; /* verde correcto */
    --danger:#ff5c6c; /* rojo incorrecto */
    --gold:#ffd166;
    --card:#121a35;
    --ink:#eef6ff;
    --muted:#b6c7ff;
    --focus:#fffb91;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    background: radial-gradient(1200px 600px at 70% 0%, var(--bg2), var(--bg));
    color:var(--ink);
  }
  .visually-hidden{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  button{border:0; cursor:pointer}
  button:focus{outline:3px solid var(--focus); outline-offset:2px}
  a{color:inherit}

  /* Layout */
  .container{max-width:1100px; margin:0 auto; padding:1rem}
  header{
    text-align:center; padding:1rem; position:relative;
  }
  header h1{font-size:clamp(1.4rem, 2.5vw + 1rem, 2.6rem); margin:.25rem 0}
  header p{color:var(--muted); margin:.25rem 0}

  .panel{
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px; padding:1rem; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }

  .toolbar{display:flex; gap:.5rem; justify-content:center; flex-wrap:wrap; align-items:center}
  .toolbar .pill{
    background:var(--card); border-radius:999px; padding:.5rem 1rem; display:flex; align-items:center; gap:.6rem; border:1px solid rgba(255,255,255,.08)
  }

  .big-cta{
    font-size:1.1rem; background:linear-gradient(180deg, var(--accent), #18a6d0); color:#01222a; font-weight:800; padding:.9rem 1.2rem; border-radius:16px; box-shadow:0 8px 12px rgba(0,0,0,.35);
    transition:transform .1s ease; min-width:240px
  }
  .big-cta:hover{transform:translateY(-2px)}

  /* Game area */
  #game{margin-top:1rem}
  .scene{
    min-height:60vh; display:grid; place-items:center; position:relative; overflow:hidden;
    background:
      radial-gradient(600px 300px at 15% 20%, rgba(57,230,255,.12), transparent 70%),
      radial-gradient(800px 380px at 85% 10%, rgba(87,255,122,.10), transparent 70%),
      radial-gradient(1000px 520px at 50% 100%, rgba(255,209,102,.08), transparent 70%);
    border-radius:18px; border:1px solid rgba(255,255,255,.08);
  }
  .ruins{
    position:absolute; inset:0; pointer-events:none;
    background:
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600">\
        <defs>\
          <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">\
            <stop offset="0" stop-color="%23121a35"/><stop offset="1" stop-color="%230b1023"/>\
          </linearGradient>\
        </defs>\
        <rect width="1200" height="600" fill="url(%23g)"/>\
        <g opacity="0.35" fill="%23ffffff">\
          <circle cx="150" cy="160" r="6"/>\
          <circle cx="280" cy="120" r="3"/>\
          <circle cx="900" cy="90" r="4"/>\
          <circle cx="1000" cy="180" r="2"/>\
        </g>\
        <g opacity="0.25" fill="%23b6c7ff">\
          <rect x="60" y="440" width="200" height="80" rx="8"/>\
          <rect x="260" y="460" width="260" height="60" rx="8"/>\
          <rect x="780" y="440" width="260" height="80" rx="8"/>\
        </g>\
        <g opacity="0.25" stroke="%23b6c7ff" stroke-width="6" fill="none">\
          <path d="M100,420 Q180,360 260,420"/>\
          <path d="M860,440 Q940,380 1020,440"/>\
        </g>\
      </svg>') center/cover no-repeat;
  }

  .fossils{
    display:grid; grid-template-columns:repeat(2,minmax(220px,1fr)); gap:1.2rem; padding:1.2rem; width:100%; max-width:900px; z-index:2
  }
  .fossil{
    --glow:0 0 0px transparent;
    background:radial-gradient(120px 80px at 60% 20%, rgba(57,230,255,.25), rgba(57,230,255,.05) 60%), var(--card);
    border:2px solid rgba(57,230,255,.3); border-radius:18px; padding:1rem; text-align:left; position:relative; isolation:isolate;
    box-shadow:var(--glow), 0 10px 18px rgba(0,0,0,.35);
    transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
    display:flex; gap:.8rem; align-items:center; min-height:120px;
  }
  .fossil:hover{ transform: translateY(-2px); box-shadow:0 0 20px rgba(57,230,255,.25), 0 16px 26px rgba(0,0,0,.35)}
  .fossil[aria-disabled="true"]{opacity:.55; filter:grayscale(.2); pointer-events:none}
  .fossil .icon{width:72px; height:72px; flex:0 0 72px}
  .fossil h3{margin:.25rem 0; font-size:1.05rem}
  .fossil p{margin:0; color:var(--muted); font-size:.95rem}

  .badge{position:absolute; top:.6rem; right:.6rem; font-size:.8rem; background:rgba(255,255,255,.1); padding:.25rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.15)}

  .choices{display:flex; gap:1rem; justify-content:center; margin-top:1rem; flex-wrap:wrap}
  .choice{
    min-width:240px; font-size:1.2rem; font-weight:800; border-radius:16px; padding:1rem; color:#071b0c;
  }
  .positive{background:linear-gradient(180deg, var(--accent2), #28b861)}
  .negative{background:linear-gradient(180deg, var(--danger), #c83b49); color:#26060a}

  .chronoscope{position:absolute; inset:0; display:none; place-items:center; backdrop-filter:blur(4px)}
  .chronoscope.active{display:grid; animation:zoomTrip .6s ease both}
  @keyframes zoomTrip{ from{transform:scale(.96); opacity:0} to{transform:scale(1); opacity:1}}

  .card{max-width:820px}
  .card h2{margin:.2rem 0 0}
  .card p{margin:.4rem 0}

  .status{min-height:1.5rem; margin-top:.4rem; color:var(--gold)}
  .status[aria-live]{padding:.25rem .5rem}

  .result-banner{padding:1rem; border-radius:16px; margin-top:.6rem; font-weight:700}
  .ok{background:linear-gradient(180deg, rgba(87,255,122,.2), rgba(87,255,122,.05)); border:1px solid rgba(87,255,122,.5)}
  .err{background:linear-gradient(180deg, rgba(255,92,108,.2), rgba(255,92,108,.05)); border:1px solid rgba(255,92,108,.5)}

  .footerbar{display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-top:1rem; flex-wrap:wrap}
  .pill small{color:var(--muted)}

  .diary{margin-top:1rem}
  details{background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:.6rem 1rem}
  summary{cursor:pointer; font-weight:700}
  table{width:100%; border-collapse:collapse; margin-top:.5rem}
  th, td{padding:.5rem .6rem; border-bottom:1px solid rgba(255,255,255,.1); text-align:left}
  tr:nth-child(even){background:rgba(255,255,255,.03)}

  /* High-contrast support */
  @media (prefers-contrast: more){
    :root{--muted:#e6f0ff}
    .fossil{border-color:#fff}
  }
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important; transition:none !important}
  }
</style>
</head>
<body>
  <div class="container" role="application" aria-label="Juego: El Arque√≥logo del Tiempo Digital. Objetivo: aprender sobre huellas digitales.">
    <header class="panel" aria-labelledby="titulo">
      <h1 id="titulo" aria-live="polite">El Arque√≥logo del Tiempo Digital: Ecos del Futuro</h1>
      <p id="sub" class="visually-hidden">Comprende qu√© es una huella digital y c√≥mo nuestras acciones en l√≠nea tienen consecuencias futuras.</p>
      <div class="toolbar" role="region" aria-label="Controles">
        <button id="startBtn" class="big-cta" aria-describedby="kbHelp">üöÄ Comenzar expedici√≥n</button>
        <div class="pill" role="group" aria-label="Preferencias de audio">
          <label for="narrationToggle"><strong>Voz en off</strong></label>
          <input id="narrationToggle" type="checkbox" aria-label="Activar o desactivar voz en off" checked />
          <span class="visually-hidden" id="kbHelp">Usa flechas para elegir positivo o negativo y Enter para confirmar.</span>
        </div>
        <div class="pill" role="group" aria-label="Accesibilidad">
          <span aria-hidden="true">‚å®Ô∏è</span><small>Flechas: elegir ¬∑ Enter: confirmar</small>
        </div>
      </div>
    </header>

    <main id="game" class="panel scene" aria-live="off">
      <div class="ruins" aria-hidden="true"></div>
      <div id="grid" class="fossils" role="list" aria-label="F√≥siles digitales">
        <!-- Fossils injected by JS -->
      </div>

      <!-- Chronoscope overlay -->
      <div id="chrono" class="chronoscope" aria-hidden="true">
        <div class="panel card" role="dialog" aria-modal="true" aria-labelledby="cTitle" aria-describedby="cDesc">
          <div class="badge" id="cBadge">Cronoscopio activo</div>
          <h2 id="cTitle">Visi√≥n del Futuro</h2>
          <p id="cCause"></p>
          <p id="cDesc"></p>
          <div class="choices" role="group" aria-label="Clasificar huella">
            <button class="choice positive" id="btnPos" aria-keyshortcuts="ArrowLeft" data-answer="positivo">üëç Huella Positiva</button>
            <button class="choice negative" id="btnNeg" aria-keyshortcuts="ArrowRight" data-answer="negativo">üëé Huella Negativa</button>
          </div>
          <div id="status" class="status" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <section class="footerbar">
      <div class="pill" aria-live="polite"><strong>Progreso:</strong> <span id="progress">0/4</span></div>
      <div class="pill"><strong>Frase:</strong> <span id="powerLine">‚Äî</span></div>
      <div class="pill"><button id="resetBtn" class="big-cta" style="min-width:auto; font-size:.95rem">üîÑ Investigar otro perfil</button></div>
    </section>

    <section class="diary">
      <details>
        <summary>üìú Diario de Ecos (local)</summary>
        <div id="diaryWrap"></div>
      </details>
    </section>
  </div>

<script>
// =================== Datos del juego =====================
const FOSILES = [
  {
    id: 'comentario-enojado',
    titulo: 'El Comentario Enojado',
    causa: 'Comentario ‚Äú¬°Perdimos por tu culpa, Leo! ¬°Eres el peor!‚Äù',
    consecuencia: 'Leo se entristece y deja el chat del equipo.',
    correcta: 'negativo',
    pista: 'Piensa en el impacto emocional y en el trabajo en equipo: ¬ømejora o empeora?'
  },
  {
    id: 'foto-pijama',
    titulo: 'La Foto Graciosa en Pijama',
    causa: 'Foto de Alex en pijama de dinosaurio con burla ‚Äú¬°Qu√© rid√≠culo!‚Äù',
    consecuencia: 'Un reclutador escolar decide no invitarlo a un club.',
    correcta: 'negativo',
    pista: 'Publicar burlas puede afectar oportunidades futuras.'
  },
  {
    id: 'post-agradecimiento',
    titulo: 'El Post de Agradecimiento',
    causa: 'Publicaci√≥n agradeciendo a Sara por ayudar con la tarea.',
    consecuencia: 'Sara sonr√≠e y fortalece su amistad con Alex.',
    correcta: 'positivo',
    pista: 'Reconocer el apoyo suele construir relaciones.'
  },
  {
    id: 'ubicacion-compartida',
    titulo: 'La Ubicaci√≥n Compartida',
    causa: 'Foto en ‚ÄúParque Aventura‚Äù con ubicaci√≥n p√∫blica.',
    consecuencia: 'Un Robadatos identifica el lugar que frecuenta Alex.',
    correcta: 'negativo',
    pista: 'Compartir ubicaci√≥n revela rutinas y lugares frecuentes.'
  },
];

// Frases de poder
const FRASES = {
  negativa: 'Una huella del pasado, puede dejar un futuro marcado.',
  positiva: 'Una palabra amable que dejas atr√°s, construye un camino de paz.'
};

// =================== Estado del juego =====================
let current = null; // √≠ndice del f√≥sil activo
let aciertos = 0;   // conteo correctos
let narracionActiva = true;
const diarioKey = 'ecos_diario_v1';

// =================== Utilidades de Audio y Voz =====================
const AudioKit = (()=>{
  const ctx = (window.AudioContext||window.webkitAudioContext) ? new (window.AudioContext||window.webkitAudioContext)() : null;
  function tone(freq=440, ms=200, type='sine', gain=0.03){
    if(!ctx) return; const o=ctx.createOscillator(); const g=ctx.createGain(); o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(ctx.destination); o.start(); setTimeout(()=>{g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.18); o.stop(ctx.currentTime+0.2)}, ms);
  }
  function chord(freqs=[440,660], ms=250){ freqs.forEach((f,i)=>tone(f, ms+ i*10, 'sine', 0.04)); }
  return {
    viaje(){ chord([520, 680, 840], 380); }, // viaje temporal
    correcto(){ chord([660, 990], 220); },  // juicio correcto
    error(){ tone(160, 280, 'square', 0.05); tone(110, 320, 'sawtooth', 0.02); },
    context: ctx
  }
})();

function speak(text){
  if(!narracionActiva) return;
  const u = new SpeechSynthesisUtterance(text);
  const prefer = (speechSynthesis.getVoices()||[]).find(v=>/es|spa/i.test(v.lang) && /mex|lat|es-/.test((v.lang||'').toLowerCase()));
  if(prefer) u.voice = prefer;
  u.lang = 'es-MX';
  u.rate = 1.02; u.pitch = 1; u.volume = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

// =================== Persistencia =====================
function cargarDiario(){
  try{ return JSON.parse(localStorage.getItem(diarioKey)||'[]'); }catch{ return [] }
}
function guardarDiario(entry){
  const d = cargarDiario();
  d.push(entry); localStorage.setItem(diarioKey, JSON.stringify(d));
  renderDiario();
}
function renderDiario(){
  const d = cargarDiario();
  const wrap = document.getElementById('diaryWrap');
  if(!d.length){ wrap.innerHTML = '<p>No hay entradas a√∫n. Explora los f√≥siles para comenzar.</p>'; return }
  const rows = d.map(e=>`<tr><td>${new Date(e.ts).toLocaleString()}</td><td>${e.titulo}</td><td>${e.respuesta}</td><td>${e.correcto?'‚úÖ':'‚ùå'}</td></tr>`).join('');
  wrap.innerHTML = `<table aria-label="Diario de Ecos"><thead><tr><th>Fecha</th><th>F√≥sil</th><th>Respuesta</th><th>Correcto</th></tr></thead><tbody>${rows}</tbody></table>`;
}

// =================== Render inicial =====================
function cardIconSVG(kind){
  // Peque√±as variaciones para cada icono
  const colors = {positivo:'%2357ff7a', negativo:'%23ff5c6c', neutro:'%2339e6ff'};
  return (
`<svg viewBox="0 0 100 100" role="img" aria-label="F√≥sil digital" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <radialGradient id="g1" cx="50%" cy="30%" r="70%"><stop offset="0%" stop-color="${colors.neutro}" stop-opacity="0.7"/><stop offset="100%" stop-color="%23121a35" stop-opacity="0.5"/></radialGradient>
  </defs>
  <rect x="8" y="14" rx="16" ry="16" width="84" height="72" fill="url(%23g1)" stroke="${colors.neutro}" stroke-opacity="0.4"/>
  <circle cx="34" cy="42" r="10" fill="${colors.neutro}" fill-opacity=".5"/>
  <rect x="52" y="36" width="26" height="8" rx="4" fill="${colors.neutro}" fill-opacity=".5"/>
  <rect x="24" y="62" width="54" height="10" rx="5" fill="${colors.neutro}" fill-opacity=".5"/>
</svg>`);
}

function renderGrid(){
  const grid = document.getElementById('grid');
  grid.innerHTML = '';
  FOSILES.forEach((f,i)=>{
    const btn = document.createElement('button');
    btn.className = 'fossil';
    btn.role = 'listitem';
    btn.setAttribute('aria-label', `${f.titulo}. ${f.causa}. Pulsa para ver consecuencia`);
    btn.setAttribute('tabindex','0');
    btn.dataset.index=i;
    btn.innerHTML = `
      <div class="icon" aria-hidden="true">${cardIconSVG('neutro')}</div>
      <div>
        <span class="badge">F√≥sil</span>
        <h3>${f.titulo}</h3>
        <p><strong>Causa:</strong> ${f.causa}</p>
      </div>`;
    btn.addEventListener('click', ()=>mostrarFosil(i));
    grid.appendChild(btn);
  });
}

// =================== Flujo de juego =====================
function iniciarJuego(){
  aciertos = 0; current = null; updateProgress(); renderGrid(); setPowerLine('‚Äî');
  enableAllFossils(true);
  speak('Bienvenido, Arque√≥logo del Tiempo Digital. Pulsa un f√≥sil para activar el Cronoscopio.');
}

function enableAllFossils(enabled){
  document.querySelectorAll('.fossil').forEach(b=>{
    b.setAttribute('aria-disabled', String(!enabled));
  });
}

function mostrarFosil(id){
  current = id;
  const f = FOSILES[id];
  // animaci√≥n + sonido de viaje
  AudioKit.viaje();
  mostrarConsecuencia(id);
}

function mostrarConsecuencia(id){
  const f = FOSILES[id];
  const overlay = document.getElementById('chrono');
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');
  document.getElementById('cTitle').textContent = 'Visi√≥n del Futuro: ' + f.titulo;
  document.getElementById('cCause').innerHTML = `<strong>Causa:</strong> ${f.causa}`;
  document.getElementById('cDesc').innerHTML = `<strong>Consecuencia:</strong> ${f.consecuencia}`;
  document.getElementById('status').textContent='Elige si esta huella es positiva o negativa.';
  speak(`Cronoscopio activo. ${f.titulo}. Causa: ${f.causa}. Consecuencia: ${f.consecuencia}. ¬øEs una huella positiva o negativa? Usa flechas y enter para elegir.`);
  // focus first choice for teclado
  document.getElementById('btnPos').focus();
}

function clasificar(respuesta){
  if(current==null) return; const f = FOSILES[current];
  const correcto = respuesta === f.correcta;
  guardarDiario({ ts: Date.now(), titulo: f.titulo, respuesta, correcto });
  feedback(correcto, f, respuesta);
  if(correcto){
    aciertos++;
    // marcar f√≥sil como procesado
    const btn = document.querySelector(`.fossil[data-index="${current}"]`);
    if(btn){ btn.style.setProperty('--glow','0 0 20px rgba(87,255,122,.45)'); btn.setAttribute('aria-disabled','true'); btn.querySelector('.badge').textContent = 'Resuelto'; }
    updateProgress();
  }
}

function feedback(correcto, f, respuesta){
  const status = document.getElementById('status');
  if(correcto){
    status.innerHTML = `<div class="result-banner ok">‚úÖ ¬°An√°lisis correcto! Has conectado la causa con su efecto.</div>`;
    setPowerLine(FRASES[f.correcta === 'positivo' ? 'positiva' : 'negativa']);
    AudioKit.correcto(); speak('¬°An√°lisis correcto! Has conectado la causa con su efecto.');
    setTimeout(()=> cerrarChronoYSeguir(), 900);
  }else{
    const pista = f.pista || 'Observa si la consecuencia protege o arriesga la privacidad.';
    status.innerHTML = `<div class="result-banner err">‚ùå Pi√©nsalo de nuevo. ¬øLa consecuencia fue buena o mala para Alex?<br><small>Pista: ${pista}</small></div>`;
    setPowerLine(FRASES['negativa']);
    AudioKit.error(); speak('Pi√©nsalo de nuevo. ¬øLa consecuencia fue buena o mala para Alex? ' + pista);
  }
}

function cerrarChronoYSeguir(){
  const overlay = document.getElementById('chrono');
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden','true');
  current = null;
  // victoria si 4/4
  if(aciertos>=FOSILES.length){
    victoria();
  }
}

function updateProgress(){
  document.getElementById('progress').textContent = `${aciertos}/${FOSILES.length}`;
}
function setPowerLine(text){ document.getElementById('powerLine').textContent = text; }

function victoria(){
  // mostrar banner arriba del grid
  const grid = document.getElementById('grid');
  const banner = document.createElement('div');
  banner.className = 'panel result-banner ok';
  banner.innerHTML = 'üèÜ ¬°Misi√≥n cumplida! El Guardi√°n de las Memorias te otorga el t√≠tulo de <em>Arque√≥logo de la Sabidur√≠a</em>. ¬°Excelente trabajo!';
  grid.prepend(banner);
  speak('Misi√≥n cumplida. Has recibido el t√≠tulo de Arque√≥logo de la Sabidur√≠a.');
}

// =================== Controles =====================
function setupControls(){
  document.getElementById('startBtn').addEventListener('click', ()=>{
    iniciarJuego();
    // mover foco al grid
    setTimeout(()=>{
      const first = document.querySelector('.fossil');
      if(first) first.focus();
    }, 50);
  });

  document.getElementById('btnPos').addEventListener('click', ()=> clasificar('positivo'));
  document.getElementById('btnNeg').addEventListener('click', ()=> clasificar('negativo'));
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    iniciarJuego();
    speak('Nuevo perfil listo para investigar.');
  });
  document.getElementById('narrationToggle').addEventListener('change', (e)=>{
    narracionActiva = e.target.checked; if(!narracionActiva){ speechSynthesis.cancel(); }
  });

  // teclado: flechas para elegir, Enter para confirmar
  document.addEventListener('keydown', (ev)=>{
    const overlay = document.getElementById('chrono');
    if(overlay.classList.contains('active')){
      const pos = document.getElementById('btnPos');
      const neg = document.getElementById('btnNeg');
      if(ev.key==='ArrowLeft'){ pos.focus(); }
      if(ev.key==='ArrowRight'){ neg.focus(); }
      if(ev.key==='Enter'){
        if(document.activeElement===pos) clasificar('positivo');
        else if(document.activeElement===neg) clasificar('negativo');
      }
      if(ev.key==='Escape'){ cerrarChronoYSeguir(); }
    }
  });
}

// =================== Inicializaci√≥n =====================
renderGrid();
setupControls();
renderDiario();

// Mensaje de bienvenida
speak('Bienvenido a Ecos del Futuro. Pulsa Comenzar expedici√≥n para iniciar.');

// =================== Service Worker en-l√≠nea (offline) =====================
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE = 'ecos-cache-v1';
    self.addEventListener('install', (e)=>{
      e.waitUntil((async()=>{
        const c = await caches.open(CACHE);
        await c.addAll([self.registration.scope]);
        self.skipWaiting();
      })());
    });
    self.addEventListener('activate', (e)=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', (e)=>{
      const req = e.request;
      e.respondWith((async()=>{
        const cached = await caches.match(req, {ignoreSearch:true});
        if(cached) return cached;
        try{ const net = await fetch(req); const c = await caches.open(CACHE); c.put(req, net.clone()); return net; }
        catch(err){ return cached || Response.error(); }
      })());
    });
  `;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const url = URL.createObjectURL(blob);
  navigator.serviceWorker.register(url).catch(()=>{});
}
</script>
</body>
</html>
