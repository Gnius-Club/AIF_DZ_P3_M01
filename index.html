<!DOCTYPE html>
<html lang="es" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0A0F1F" />
<title>El Arque√≥logo del Tiempo Digital: Ecos del Futuro</title>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Ecos del Futuro&quot;,&quot;short_name&quot;:&quot;Ecos&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#0A0F1F&quot;,&quot;theme_color&quot;:&quot;#0A0F1F&quot;}" />
<style>
  /* ====== Paleta con contraste accesible ====== */
  :root{
    --bg:#0A0F1F; --bg2:#0f1833; --card:#111A33; --ink:#FFFFFF; --muted:#D7E3FF;
    --accent:#2FD0FF; --accent2:#39E06C; --danger:#E64556; --gold:#FFC540; --focus:#FFF176;
    --chip-chat:#2B7EA7; --chip-foto:#B88600; --chip-post:#2C8C4A; --chip-ubi:#B04A35;
    --cc-bg:rgba(0,0,0,.6); --cc-ink:#fff; --cc-border:rgba(255,255,255,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial; background:radial-gradient(1200px 600px at 70% 0%, var(--bg2), var(--bg)); color:var(--ink)}
  .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  button{border:0; cursor:pointer}
  button:focus-visible{outline:4px solid var(--focus); outline-offset:3px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:1rem}
  header.panel{display:flex; gap:.6rem; align-items:center; justify-content:space-between; flex-wrap:wrap}
  header h1{margin:.2rem 0; font-size:clamp(1.3rem,2.2vw+1rem,2.3rem)}
  .toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
  .btn{border-radius:14px; padding:.55rem 1rem; font-weight:800}
  .btn-cta{background:linear-gradient(180deg, var(--accent), #0da1d1); color:#fff}
  .btn-ghost{background:transparent; color:var(--ink); border:2px solid var(--accent)}
  .switch{display:flex; align-items:center; gap:.4rem; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); padding:.35rem .6rem; border-radius:12px}

  .progress-bar{display:flex; gap:.6rem; justify-content:center; margin:.5rem auto}
  .progress-dot{width:20px; height:20px; border-radius:50%; background:#6d7fb0; border:2px solid #3b4a7a}
  .progress-dot.correct{background:var(--accent2); border-color:#1d6b32}
  .progress-dot.retry{background:var(--danger); border-color:#6b1220}

  .fossils{display:grid; grid-template-columns:repeat(2,minmax(240px,1fr)); gap:1rem; padding:1rem}
  .fossil{background:var(--card); border-radius:18px; padding:1rem; display:flex; gap:.8rem; align-items:center; box-shadow:0 10px 18px rgba(0,0,0,.35)}
  .fossil .icon{width:56px;height:56px;flex:0 0 56px;color:var(--ink)}
  .fossil h3{margin:.15rem 0 .25rem 0; font-size:1.05rem; color:var(--ink)}
  .fossil p{margin:0; color:var(--muted)}
  .chip{display:inline-block; padding:.25rem .6rem; border-radius:12px; font-size:.8rem; margin-bottom:.25rem; font-weight:800;color:#fff}
  .chip--Comentario{background:var(--chip-chat)}
  .chip--Foto{background:var(--chip-foto)}
  .chip--Post{background:var(--chip-post)}
  .chip--Ubicaci√≥n{background:var(--chip-ubi)}

  #chrono{display:none; margin-top:1rem}
  #chrono.active{display:block; animation:zoomIn .35s ease}
  @keyframes zoomIn{from{transform:scale(.97);opacity:0}to{transform:scale(1);opacity:1}}
  #cIcon{display:flex; justify-content:center; margin:.3rem 0}
  #cIcon svg{max-width:160px}
  .qbadge{display:none; align-items:center; justify-content:center; gap:.4rem; margin:.4rem auto 0; width:max-content; padding:.2rem .6rem; border-radius:999px; font-weight:800; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22)}
  .choices{display:flex; gap:1rem; justify-content:center; margin-top:1rem}
  .choice{min-width:240px; font-size:1.1rem; font-weight:900; border-radius:16px; padding:.9rem 1rem; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .positive{background:linear-gradient(180deg, var(--accent2), #1f8f4a)}
  .negative{background:linear-gradient(180deg, var(--danger), #9e1c2b)}

  #cc{margin:.6rem auto; max-width:1000px}
  #ccLive{background:var(--cc-bg); color:var(--cc-ink); border:2px solid var(--cc-border); border-radius:12px; padding:.6rem .8rem}
  #ccLog{margin-top:.4rem; max-height:140px; overflow:auto; font-size:.9rem; color:var(--muted)}

  .album,.diary{margin:1rem auto; max-width:1000px}
  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.8rem}
  .card-know{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:.6rem}

  .diploma{display:none; text-align:center; margin:1rem auto}
  .diploma canvas{max-width:100%; border:3px solid var(--gold); border-radius:16px}

  /* Tutorial */
  .tut-overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-start; justify-content:center; z-index:9999; opacity:0; pointer-events:none; transition:opacity .2s}
  .tut-overlay.active{display:flex; opacity:1; pointer-events:auto}
  .tut-coach{margin-top:6vh; max-width:820px; background:var(--card); border:2px solid rgba(255,255,255,.25); border-radius:16px; padding:1rem}
  .tut-actions{display:flex; gap:.6rem; justify-content:flex-end; margin-top:.6rem}
  .highlight-ring{position:relative; z-index:9998; outline:4px solid var(--focus); outline-offset:2px; border-radius:12px}
</style>
</head>
<body>
  <header class="panel">
    <h1>El Arque√≥logo del Tiempo Digital: Ecos del Futuro</h1>
    <div class="toolbar">
      <button id="startBtn" class="btn btn-cta">üöÄ Comenzar expedici√≥n</button>
      <button id="tutorialBtn" class="btn btn-ghost" title="Tutorial guiado">üß≠ Tutorial</button>
      <button id="challengeToggle" class="btn btn-ghost" aria-pressed="false" title="Modo Reto 90s">‚è±Ô∏è Modo Reto</button>
      <div class="switch" aria-label="Tiempo restante"><strong>‚è≥</strong> <span id="timer">‚Äî</span></div>
      <div class="switch" aria-label="Energ√≠a Cronoscopio"><strong>‚ö°</strong><span id="energyBar" style="display:inline-flex; gap:.25rem"></span></div>
    </div>
  </header>

  <div id="progressBar" class="progress-bar" role="status" aria-label="Progreso"></div>

  <main id="game" class="panel">
    <div id="grid" class="fossils" role="list" aria-label="F√≥siles"></div>

    <div id="chrono" class="panel" role="dialog" aria-modal="true" aria-labelledby="cTitle" aria-describedby="cDesc">
      <h2 id="cTitle">Visi√≥n del Futuro</h2>
      <div id="cIcon" aria-hidden="true"></div>
      <p id="cCause"></p>
      <p id="cDesc"></p>
      <div id="qBadge" class="qbadge" aria-hidden="true">‚è≤Ô∏è <span id="qTime">12</span>s</div>
      <div class="choices" role="group" aria-label="Clasificar huella">
        <button class="choice positive" id="btnPos">üëç Huella Positiva <small style="display:block; font-weight:600">(ayuda, respeto)</small></button>
        <button class="choice negative" id="btnNeg">üëé Huella Negativa <small style="display:block; font-weight:600">(riesgo, da√±o)</small></button>
      </div>
      <div id="status" role="status" aria-live="polite" style="margin-top:.5rem"></div>
    </div>
  </main>

  <section id="cc" aria-label="Subt√≠tulos">
    <div id="ccLive" aria-live="polite">‚Äî</div>
    <div id="ccLog" aria-live="off"></div>
  </section>

  <section class="panel album" id="albumSection">
    <h2>üìö √Ålbum de Conocimiento</h2>
    <div class="cards" id="albumCards"></div>
  </section>

  <section class="panel diary" id="diarySection">
    <h2>üìù Diario de Ecos</h2>
    <div id="diaryWrap"></div>
  </section>

  <section class="diploma" id="diplomaSection">
    <h2>üèÜ Diploma</h2>
    <canvas id="diplomaCanvas" width="900" height="560" aria-label="Diploma"></canvas>
    <p><button id="downloadDiploma" class="btn btn-cta">Descargar Diploma</button></p>
  </section>

  <!-- Overlay Tutorial -->
  <div class="tut-overlay" id="tutOverlay" role="dialog" aria-modal="true" aria-labelledby="tutTitle" aria-describedby="tutDesc" tabindex="-1">
    <div class="tut-coach">
      <h2 id="tutTitle">üß≠ Tutorial guiado</h2>
      <div id="tutDesc"></div>
      <p class="tut-note">Usa <strong>Enter</strong> para continuar o <strong>Esc</strong> para salir.</p>
      <div class="tut-actions">
        <button class="btn btn-ghost" id="tutSkip">Saltar</button>
        <button class="btn btn-cta" id="tutPrev">‚Üê Atr√°s</button>
        <button class="btn btn-cta" id="tutNext">Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

<script>
/******** Datos ********/
const BASE_FOSILES=[
 {id:'comentario', titulo:'El Comentario Enojado', tipo:'Comentario', causa:'Comentario ‚Äú¬°Perdimos por tu culpa, Leo! ¬°Eres el peor!‚Äù', consecuencia:'Leo se entristece y deja el chat del equipo.', correcta:'negativo', pistas:['Observa c√≥mo se siente la otra persona.','Un comentario hiriente da√±a el equipo.','Regla de oro: Trata como quieres ser tratado.'], card:'Usa lenguaje respetuoso.'},
 {id:'foto', titulo:'La Foto Graciosa en Pijama', tipo:'Foto', causa:'Foto de Alex en pijama con burla ‚Äú¬°Qu√© rid√≠culo!‚Äù', consecuencia:'Un reclutador escolar decide no invitarlo a un club.', correcta:'negativo', pistas:['Las burlas p√∫blicas permanecen.','Afecta oportunidades futuras.','No publiques para ridiculizar.'], card:'Piensa antes de publicar.'},
 {id:'post', titulo:'El Post de Agradecimiento', tipo:'Post', causa:'Publicaci√≥n agradeciendo a Sara por ayudar.', consecuencia:'Sara sonr√≠e y fortalece su amistad con Alex.', correcta:'positivo', pistas:['¬øMejora la amistad?','Reconocer apoyo crea confianza.','Regla: Gratitud y respeto.'], card:'La gratitud p√∫blica es positiva.'},
 {id:'ubicacion', titulo:'La Ubicaci√≥n Compartida', tipo:'Ubicaci√≥n', causa:'Foto en ‚ÄúParque Aventura‚Äù con ubicaci√≥n p√∫blica.', consecuencia:'Un Robadatos identifica el lugar que frecuenta Alex.', correcta:'negativo', pistas:['Muestra tus rutinas.','Desconocidos podr√≠an encontrarte.','Evita ubicaci√≥n en tiempo real.'], card:'No publiques ubicaci√≥n en tiempo real.'}
];

/******** Estado ********/
const LS_ALBUM_KEY='ecos_album_v1'; const LS_DIARY_KEY='ecos_diario_v2';
let orden=[], aciertos=0, intentos=[], current=null, energy=3, reto=false, tiempo=0, ticker=null, narrationOn=true, startedAt=null, bonusEstrellas=0;
const RETO_TOTAL=90, RETO_PER_ATTEMPT=12; let qTicker=null, qTime=0; let currentSession=null;
let tutorialMode=false, tutorialStep=0; let trapPrevFocus=null;

/******** Voz + CC ********/
function cc(text){ const live=document.getElementById('ccLive'); const log=document.getElementById('ccLog'); if(!live) return; live.textContent=text; const stamp=new Date().toLocaleTimeString(); const div=document.createElement('div'); div.textContent=`[${stamp}] ${text}`; (log||{prepend:()=>{}}).prepend(div); }
function speakBase(prefix, text, {rate=1, pitch=1}={}){ const full=`${prefix}${text}`; cc(full); if(!narrationOn||!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(full); u.lang='es-MX'; u.rate=rate; u.pitch=pitch; try{ speechSynthesis.cancel(); }catch{} speechSynthesis.speak(u); }
const speakGuardian=(t)=>speakBase('Guardi√°n: ', t,{rate:1.02,pitch:1.15});
const speakSystem=(t)=>speakBase('', t,{rate:1.0,pitch:0.95});

/******** Util ********/
function shuffle(a){const x=a.slice(); for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [x[i],x[j]]=[x[j],x[i]];} return x;}
function iconForTypeSVG(tipo, size=56){
  const common=(b)=>`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='${size}' height='${size}' role='img' aria-label='${tipo}' style='color:var(--ink)'>${b}</svg>`;
  if(tipo==='Comentario') return common(`<rect x='10' y='20' rx='14' width='100' height='70' fill='var(--chip-chat)'></rect><circle cx='28' cy='50' r='6' fill='currentColor'/><circle cx='48' cy='50' r='6' fill='currentColor'/><circle cx='68' cy='50' r='6' fill='currentColor'/><path d='M30 90 L20 110 L48 92' fill='var(--chip-chat)'/>`);
  if(tipo==='Foto') return common(`<rect x='14' y='24' rx='10' width='92' height='72' fill='var(--chip-foto)'></rect><circle cx='44' cy='50' r='10' fill='currentColor'/><path d='M34 78 L54 58 L72 72 L86 60 L100 78 Z' fill='currentColor'/>`);
  if(tipo==='Post') return common(`<rect x='16' y='24' rx='10' width='88' height='72' fill='var(--chip-post)'></rect><rect x='28' y='40' width='64' height='10' rx='5' fill='currentColor'/><rect x='28' y='58' width='48' height='10' rx='5' fill='currentColor'/><path d='M90 84 a10 10 0 1 1 -20 0 a10 10 0 1 1 20 0' fill='currentColor'/>`);
  return common(`<rect x='20' y='20' rx='12' width='80' height='80' fill='var(--chip-ubi)'></rect><path d='M60 36a18 18 0 0 0-18 18c0 14 18 36 18 36s18-22 18-36A18 18 0 0 0 60 36zm0 12a6 6 0 1 1 0 12 6 6 0 0 1 0-12z' fill='currentColor'/>`);
}
function microVignetteSVG(t){return iconForTypeSVG(t,140)}
function setEnergy(e){ energy=Math.max(0,Math.min(3,e)); const bar=document.getElementById('energyBar'); if(!bar) return; bar.innerHTML=''; for(let i=0;i<3;i++){const b=document.createElement('span'); b.style.width='18px';b.style.height='26px';b.style.display='inline-block';b.style.clipPath='polygon(45% 0, 60% 0, 40% 40%, 65% 40%, 25% 100%, 40% 60%, 15% 60%)'; b.style.background=i<energy?'var(--accent2)':'#6d7fb0'; b.style.border='2px solid '+(i<energy?'#1d6b32':'#3b4a7a'); bar.appendChild(b);} }
function setTimerText(t){ const el=document.getElementById('timer'); if(el) el.textContent=t; }

/******** Render ********/
function renderProgress(){ const bar=document.getElementById('progressBar'); bar.innerHTML=''; orden.forEach((idx,i)=>{ const dot=document.createElement('div'); dot.className='progress-dot pending'; dot.id='dot'+i; dot.title=BASE_FOSILES[idx].titulo; bar.appendChild(dot); }); }
function renderGrid(){ const grid=document.getElementById('grid'); grid.innerHTML=''; orden.forEach((idx,i)=>{ const f=BASE_FOSILES[idx]; const btn=document.createElement('button'); btn.className='fossil'; btn.setAttribute('role','listitem'); btn.setAttribute('aria-label', `${f.titulo}. ${f.causa}. Abrir cronoscopio.`); btn.innerHTML=`<div class="icon">${iconForTypeSVG(f.tipo)}</div><div><span class="chip chip--${f.tipo}">${f.tipo}</span><h3>${f.titulo}</h3><p><strong>Causa:</strong> ${f.causa}</p></div>`; btn.onclick=()=>mostrarFosil(i); grid.appendChild(btn); }); }

/******** Inicio / Reto ********/
function iniciar(r){
  reto=!!r; if(ticker){clearInterval(ticker); ticker=null;} if(qTicker){clearInterval(qTicker); qTicker=null;}
  bonusEstrellas=0; startedAt=Date.now();
  if(reto){ tiempo=90; setTimerText(tiempo+'s'); ticker=setInterval(()=>{ tiempo--; setTimerText(tiempo+'s'); if(tiempo<=0){ onGlobalTimeout(); } },1000);} else { setTimerText('‚Äî'); tiempo=0; }
  orden=shuffle(BASE_FOSILES.map((_,i)=>i)); intentos=Array(orden.length).fill(0); aciertos=0; current=null; setEnergy(3);
  renderProgress(); renderGrid(); document.getElementById('diplomaSection').style.display='none'; document.getElementById('chrono').style.display='none';
  currentSession={ startedAt, reto, order:[...orden], fossils: orden.map(idx=>({ id:BASE_FOSILES[idx].id, titulo:BASE_FOSILES[idx].titulo, intentos:0, pistas:0, respuesta:'', correct:false, reflexion:'' })), cardsGained:[] };
  if(!tutorialMode) speakGuardian('Bienvenido. Elige un f√≥sil y usa el Cronoscopio.');
}

/******** Cronoscopio + Trap ********/
function mostrarFosil(i){ current=i; const f=BASE_FOSILES[orden[i]]; const ch=document.getElementById('chrono'); ch.classList.add('active'); ch.style.display='block'; document.getElementById('cTitle').textContent=f.titulo; document.getElementById('cCause').textContent='Causa: '+f.causa; document.getElementById('cDesc').textContent='Consecuencia: '+f.consecuencia; document.getElementById('cIcon').innerHTML=microVignetteSVG(f.tipo); document.getElementById('status').textContent='Elige si la huella es positiva o negativa.'; const first=document.getElementById('btnPos'); if(first) first.focus(); if(!tutorialMode) speakGuardian('Observa la visi√≥n. ¬øHuella positiva o negativa?'); if(reto) startAttemptTimer(); }
function updateQBadge(){ const b=document.getElementById('qBadge'); const t=document.getElementById('qTime'); if(!b||!t) return; if(reto && current!=null){ b.style.display='inline-flex'; t.textContent=qTime; } else { b.style.display='none'; } }
function clearAttemptTimer(){ if(qTicker){ clearInterval(qTicker); qTicker=null; } qTime=0; updateQBadge(); }
function startAttemptTimer(){ clearAttemptTimer(); qTime=RETO_PER_ATTEMPT; updateQBadge(); qTicker=setInterval(()=>{ qTime--; updateQBadge(); if(qTime<=0){ clearAttemptTimer(); penalizeTimeout(); } },1000); }
function penalizeTimeout(){ if(current==null) return; const f=BASE_FOSILES[orden[current]]; intentos[current] = (intentos[current]||0) + 1; const foss=currentSession? currentSession.fossils[current] : null; if(foss){ foss.intentos=intentos[current]; foss.pistas=Math.min(f.pistas.length, intentos[current]); } const dot=document.getElementById('dot'+current); if(dot) dot.className='progress-dot retry'; setEnergy(energy-1); const paso=Math.min(intentos[current], f.pistas.length)-1; const pistaTxt=f.pistas[paso]||'¬øProtege o arriesga la privacidad?'; document.getElementById('status').innerHTML='‚è≤Ô∏è Tiempo agotado.<br><small>'+pistaTxt+'</small>'; speakSystem('Tiempo agotado. '+pistaTxt); if(document.getElementById('chrono').classList.contains('active')){ if(reto) startAttemptTimer(); } }

/******** Clasificar + Reflexi√≥n ********/
function clasificar(resp){ clearAttemptTimer(); if(current==null) return; const f=BASE_FOSILES[orden[current]]; const correcto=(resp===f.correcta); const dot=document.getElementById('dot'+current); const foss=currentSession? currentSession.fossils[current] : null; if(foss) foss.respuesta=resp;
  if(correcto){ if(foss) foss.correct=true; aciertos++; if(dot) dot.className='progress-dot correct'; setEnergy(Math.min(3, energy+1)); speakSystem('¬°An√°lisis correcto! Conectaste causa y efecto.');
    document.getElementById('status').innerHTML=`<div class='panel' style='margin-top:.5rem'><strong>Reflexi√≥n:</strong> ¬øQu√© habr√≠a sido una mejor alternativa?<br><div style='display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.5rem'><button class='choice positive' style='min-width:180px' id='optA'>${
      f.id==='comentario'?'Pedir disculpas y apoyar a Leo': f.id==='foto'?'Pedir permiso antes de publicar': f.id==='post'?'Agradecer en p√∫blico con respeto':'Compartir ubicaci√≥n despu√©s (no en tiempo real)'
    }</button><button class='choice negative' style='min-width:180px' id='optB'>${
      f.id==='comentario'?'No escribir cuando est√°s enojado': f.id==='foto'?'Mantener fotos privadas si averg√ºenzan': f.id==='post'?'Escribir nota privada de agradecimiento':'Enviar lugar por mensaje privado a amigos'
    }</button></div></div>`;
    const save=(sel)=>{ if(!tutorialMode){ const album=JSON.parse(localStorage.getItem(LS_ALBUM_KEY)||'[]'); album.push('Reflexi√≥n - '+f.titulo+': '+sel); localStorage.setItem(LS_ALBUM_KEY, JSON.stringify(album)); renderAlbum(); } cerrarCrono(); if(aciertos===orden.length) finalizar(); };
    document.getElementById('optA').onclick=()=>save(document.getElementById('optA').textContent);
    document.getElementById('optB').onclick=()=>save(document.getElementById('optB').textContent);
  } else { if(foss){ intentos[current]++; foss.intentos=intentos[current]; foss.pistas=Math.min(f.pistas.length,intentos[current]); }
    if(dot) dot.className='progress-dot retry'; setEnergy(energy-1); const paso=Math.min(intentos[current], f.pistas.length)-1; const pistaTxt=f.pistas[paso]||'Observa si la consecuencia ayuda o da√±a.'; document.getElementById('status').innerHTML='‚ùå Pi√©nsalo de nuevo.<br><small>'+pistaTxt+'</small>'; speakSystem('Pi√©nsalo de nuevo. '+pistaTxt); }
}
function cerrarCrono(){ const c=document.getElementById('chrono'); c.classList.remove('active'); c.style.display='none'; current=null; }

/******** Global timeout ********/
function onGlobalTimeout(){ if(ticker){clearInterval(ticker); ticker=null;} setTimerText('0s'); setEnergy(energy-1); speakSystem('‚è≤Ô∏è Tiempo total agotado. Pierdes una carga del Cronoscopio, pero puedes continuar.'); reto=false; const ch=document.getElementById('challengeToggle'); ch.setAttribute('aria-pressed','false'); ch.textContent='‚è±Ô∏è Modo Reto'; clearAttemptTimer(); }

/******** Diploma + √Ålbum + Diario (m√≠nimo) ********/
function drawStar(ctx,x,y,r,n,inset,color){ctx.save();ctx.fillStyle=color;ctx.beginPath();ctx.translate(x,y);ctx.moveTo(0,0-r);for(let i=0;i<n;i++){ctx.rotate(Math.PI/n);ctx.lineTo(0,0-(r/inset));ctx.rotate(Math.PI/n);ctx.lineTo(0,0-r);}ctx.fill();ctx.restore();}
function mostrarDiploma(){ const section=document.getElementById('diplomaSection'); section.style.display='block'; const canvas=document.getElementById('diplomaCanvas'); const ctx=canvas.getContext('2d'); const css=getComputedStyle(document.body); const cInk=(css.getPropertyValue('--ink')||'#222').trim(); const cCard=(css.getPropertyValue('--card')||'#fff8e1').trim(); const cGold=(css.getPropertyValue('--gold')||'#fbc02d').trim(); ctx.fillStyle=cCard; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.strokeStyle=cGold; ctx.lineWidth=12; ctx.strokeRect(24,24,canvas.width-48,canvas.height-48); ctx.fillStyle=cInk; ctx.font='bold 40px Arial'; ctx.fillText('Diploma: Arque√≥logo/a de la Sabidur√≠a', 60, 130); ctx.font='22px Arial'; ctx.fillText('Por clasificar correctamente los 4 f√≥siles', 60, 175); const stars=reto&&tiempo>20?Math.min(3,1+Math.floor((tiempo-20)/20)):0; for(let i=0;i<stars;i++){drawStar(ctx,60+i*40,210,14,5,2,cGold);} const date=new Date().toLocaleDateString(); ctx.fillStyle=(css.getPropertyValue('--muted')||'#555').trim(); ctx.font='20px Arial'; ctx.fillText('Fecha: '+date,60,245); }
function renderAlbum(){ const box=document.getElementById('albumCards'); const cards=JSON.parse(localStorage.getItem(LS_ALBUM_KEY)||'[]'); box.innerHTML=cards.length?cards.map(c=>`<div class='card-know'><h4>Tarjeta</h4><p>${c}</p></div>`).join(''):'<p>Sin tarjetas a√∫n.</p>'; }
function renderDiary(){ const wrap=document.getElementById('diaryWrap'); const d=JSON.parse(localStorage.getItem(LS_DIARY_KEY)||'[]'); wrap.innerHTML=d.length? d.map((s,si)=>`<details ${si===0?'open':''}><summary>${new Date(s.startedAt).toLocaleString()} ¬∑ ${s.reto?'Reto 90s':'Normal'} ¬∑ Tiempo: ${s.totalSeconds}s ¬∑ Pistas: ${s.totalHints} ¬∑ Correctos: ${s.correct}/${s.total}</summary></details>`).join('') : '<p>Sin sesiones a√∫n.</p>'; }
function finalizar(){ if(ticker){clearInterval(ticker); ticker=null;} clearAttemptTimer(); const finishedAt=Date.now(); const totalSeconds = currentSession && currentSession.reto ? (90 - tiempo) : Math.round((finishedAt - startedAt)/1000); const totalHints = currentSession ? currentSession.fossils.reduce((a,b)=>a+(b.pistas||0),0) : 0; if(currentSession){ currentSession.finishedAt=finishedAt; currentSession.totalSeconds=totalSeconds; currentSession.totalHints=totalHints; currentSession.correct=aciertos; currentSession.total=orden.length; const d=JSON.parse(localStorage.getItem(LS_DIARY_KEY)||'[]'); d.unshift(currentSession); localStorage.setItem(LS_DIARY_KEY, JSON.stringify(d)); renderDiary(); } speakGuardian('¬°Misi√≥n cumplida! Has obtenido el t√≠tulo de Arque√≥logo de la Sabidur√≠a.'); mostrarDiploma(); }

/******** Tutorial ********/
const tutOverlay=document.getElementById('tutOverlay'); const tutDesc=document.getElementById('tutDesc'); const tutTitle=document.getElementById('tutTitle');
const tutNext=document.getElementById('tutNext'); const tutPrev=document.getElementById('tutPrev'); const tutSkip=document.getElementById('tutSkip');
const TSTEPS=[
  {title:'Bienvenida',sel:null,txt:'Te ense√±ar√© la din√°mica y cada herramienta: f√≥siles, cronoscopio, vidas ‚ö°, Modo Reto ‚è±, pistas, subt√≠tulos y diploma.',act:()=>{speakGuardian('Bienvenido al tutorial.');}},
  {title:'Panel superior',sel:'.toolbar',txt:'Aqu√≠ controlas el juego: Comenzar, Tutorial, Modo Reto, temporizador y energ√≠a ‚ö°.',act:()=>{}},
  {title:'Progreso',sel:'#progressBar',txt:'Estos puntos muestran tu avance. Verde=correcto, Rojo=reintento.',act:()=>{}},
  {title:'F√≥siles',sel:'#grid',txt:'Elige uno para abrir el Cronoscopio. Haremos clic por ti en un ejemplo.',act:()=>{if(!orden.length) iniciar(false); const b=document.querySelector('#grid .fossil'); if(b){ b.classList.add('highlight-ring'); setTimeout(()=>b.click(),600); }}},
  {title:'Cronoscopio',sel:'#chrono',txt:'Ver√°s la causa y su eco en el futuro. Decide si es positiva o negativa.',act:()=>{speakGuardian('Observa y decide.')}},
  {title:'Botones de decisi√≥n',sel:'#chrono .choices',txt:'Elige üëç o üëé. En Modo Reto ver√°s un temporizador por intento.',act:()=>{}},
  {title:'Pistas',sel:'#status',txt:'Si fallas o se agota el tiempo, ver√°s pistas cada vez m√°s claras.',act:()=>{}},
  {title:'Vidas ‚ö°',sel:'#energyBar',txt:'Cada error o tiempo agotado consume una carga; cada acierto recarga una.',act:()=>{}},
  {title:'Modo Reto ‚è±',sel:'#challengeToggle',txt:'90s globales + 12s por intento. Aumenta el reto y la atenci√≥n.',act:()=>{}},
  {title:'Subt√≠tulos',sel:'#cc',txt:'Todo lo narrado aparece tambi√©n como texto aqu√≠.',act:()=>{}},
  {title:'√Ålbum y Diario',sel:'#albumSection',txt:'Colecciona tarjetas al acertar y revisa tu evidencia en el Diario.',act:()=>{}},
  {title:'Diploma',sel:'#diplomaSection',txt:'Al completar los 4 f√≥siles obtendr√°s un diploma descargable.',act:()=>{}},
  {title:'¬°Listo!',sel:null,txt:'Fin del tutorial. Ahora juega una partida real.',act:()=>{}}
];
function highlight(sel){ document.querySelectorAll('.highlight-ring').forEach(el=>el.classList.remove('highlight-ring')); if(!sel) return; const el=document.querySelector(sel); if(el){ el.classList.add('highlight-ring'); el.scrollIntoView({behavior:'smooth', block:'center'}); } }
function showStep(i){ tutorialStep=i; const s=TSTEPS[i]; tutTitle.textContent='üß≠ '+s.title; tutDesc.textContent=s.txt; highlight(s.sel); if(typeof s.act==='function') s.act(); tutPrev.disabled=(i===0); tutNext.textContent=(i===TSTEPS.length-1)?'Finalizar':'Siguiente ‚Üí'; }
function startTutorial(){ tutorialMode=true; if(!orden.length) iniciar(false); setTimeout(()=>{ tutOverlay.classList.add('active'); tutOverlay.focus(); showStep(0); }, 50); }
function endTutorial(){ tutorialMode=false; tutOverlay.classList.remove('active'); document.querySelectorAll('.highlight-ring').forEach(el=>el.classList.remove('highlight-ring')); }

tutNext.onclick=()=>{ if(tutorialStep<TSTEPS.length-1) showStep(tutorialStep+1); else endTutorial(); };
 tutPrev.onclick=()=>{ if(tutorialStep>0) showStep(tutorialStep-1); };
 tutSkip.onclick=()=> endTutorial();
 document.getElementById('tutorialBtn').onclick=()=> startTutorial();
 document.addEventListener('keydown',(e)=>{ if(!tutorialMode) return; if(e.key==='Enter'||e.key===' '){ e.preventDefault(); tutNext.click(); } if(e.key==='Escape'){ e.preventDefault(); tutSkip.click(); } });

/******** Eventos UI ********/
 document.getElementById('btnPos').onclick=()=>clasificar('positivo');
 document.getElementById('btnNeg').onclick=()=>clasificar('negativo');
 document.getElementById('startBtn').onclick=()=>{ tutorialMode=false; iniciar(reto); };
 document.getElementById('challengeToggle').onclick=(e)=>{ reto=!reto; e.currentTarget.setAttribute('aria-pressed', reto); e.currentTarget.textContent = reto? '‚è±Ô∏è Modo Reto ON' : '‚è±Ô∏è Modo Reto'; if(reto){ if(!tiempo||tiempo<=0){ tiempo=90; setTimerText(tiempo+'s'); } if(!ticker){ ticker=setInterval(()=>{ tiempo--; setTimerText(tiempo+'s'); if(tiempo<=0){ onGlobalTimeout(); } },1000);} if(current!=null) startAttemptTimer(); speakSystem('Modo Reto activado.'); } else { if(ticker){ clearInterval(ticker); ticker=null; } clearAttemptTimer(); setTimerText('‚Äî'); speakSystem('Modo Reto desactivado.'); } };
 document.getElementById('downloadDiploma').onclick=()=>{ const canvas=document.getElementById('diplomaCanvas'); const a=document.createElement('a'); a.download='diploma.png'; a.href=canvas.toDataURL('image/png'); a.click(); };

/******** Inicial ********/
setEnergy(3); (function bootstrap(){ orden=BASE_FOSILES.map((_,i)=>i); renderProgress(); renderGrid(); cc('Guardi√°n: Bienvenido a Ecos del Futuro. Pulsa Comenzar expedici√≥n o abre el Tutorial.'); })();

/******** SW Offline ********/
if('serviceWorker' in navigator){ const sw=`const C='ecos-v3'; self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll([self.registration.scope])).then(()=>self.skipWaiting()))}); self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())}); self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request,{ignoreSearch:true}).then(r=>r||fetch(e.request).then(res=>{const cp=res.clone(); caches.open(C).then(c=>c.put(e.request,cp)); return res;}).catch(()=>r)))})`; const url=URL.createObjectURL(new Blob([sw],{type:'text/javascript'})); navigator.serviceWorker.register(url).catch(()=>{}); }
</script>
</body>
</html>
