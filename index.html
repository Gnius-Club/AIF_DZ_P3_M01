<!DOCTYPE html>
<html lang="es" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0A0F1F" />
<title>El Arque√≥logo del Tiempo Digital: Ecos del Futuro</title>
<link rel="manifest" href="data:application/manifest+json,{&quot;name&quot;:&quot;Ecos del Futuro&quot;,&quot;short_name&quot;:&quot;Ecos&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#0A0F1F&quot;,&quot;theme_color&quot;:&quot;#0A0F1F&quot;}" />
<style>
  /* ====== Paleta con contraste accesible ====== */
  :root{
    --bg:#0A0F1F; --bg2:#0f1833; --card:#111A33; --ink:#FFFFFF; --muted:#D7E3FF;
    --accent:#2FD0FF; --accent2:#39E06C; --danger:#E64556; --gold:#FFC540; --focus:#FFF176;
    --chip-chat:#2B7EA7; --chip-foto:#B88600; --chip-post:#2C8C4A; --chip-ubi:#B04A35;
    --cc-bg:rgba(0,0,0,.6); --cc-ink:#fff; --cc-border:rgba(255,255,255,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial; background:radial-gradient(1200px 600px at 70% 0%, var(--bg2), var(--bg)); color:var(--ink); padding-bottom: 4rem;}
  .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  button{border:0; cursor:pointer}
  button:focus-visible{outline:4px solid var(--focus); outline-offset:3px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:1rem}
  header.panel{display:flex; gap:.6rem; align-items:center; justify-content:space-between; flex-wrap:wrap}
  header h1{margin:.2rem 0; font-size:clamp(1.3rem,2.2vw+1rem,2.3rem)}
  .toolbar{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
  .btn{border-radius:14px; padding:.55rem 1rem; font-weight:800; transition: transform 0.1s;}
  .btn:active{transform: scale(0.96);}
  .btn-cta{background:linear-gradient(180deg, var(--accent), #0da1d1); color:#fff}
  .btn-ghost{background:transparent; color:var(--ink); border:2px solid var(--accent)}
  .switch{display:flex; align-items:center; gap:.4rem; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); padding:.35rem .6rem; border-radius:12px}

  .progress-bar{display:flex; gap:.6rem; justify-content:center; margin:.5rem auto}
  .progress-dot{width:20px; height:20px; border-radius:50%; background:#6d7fb0; border:2px solid #3b4a7a}
  .progress-dot.correct{background:var(--accent2); border-color:#1d6b32}
  .progress-dot.retry{background:var(--danger); border-color:#6b1220}

  .fossils{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:1rem; padding:1rem}
  .fossil{background:var(--card); border-radius:18px; padding:1rem; display:flex; gap:.8rem; align-items:center; box-shadow:0 10px 18px rgba(0,0,0,.35); text-align: left; transition: transform 0.2s, box-shadow 0.2s;}
  .fossil:hover{transform: translateY(-3px); box-shadow: 0 14px 24px rgba(0,0,0,0.5);}
  .fossil.solved{opacity: 0.6; filter: grayscale(0.5);}
  .fossil .icon{width:56px;height:56px;flex:0 0 56px;color:var(--ink)}
  .fossil h3{margin:.15rem 0 .25rem 0; font-size:1.05rem; color:var(--ink)}
  .fossil p{margin:0; color:var(--muted)}
  .chip{display:inline-block; padding:.25rem .6rem; border-radius:12px; font-size:.8rem; margin-bottom:.25rem; font-weight:800;color:#fff}
  .chip--Comentario{background:var(--chip-chat)}
  .chip--Foto{background:var(--chip-foto)}
  .chip--Post{background:var(--chip-post)}
  .chip--Ubicaci√≥n{background:var(--chip-ubi)}

  #chrono{display:none; margin-top:1rem}
  #chrono.active{display:block; animation:zoomIn .35s ease}
  @keyframes zoomIn{from{transform:scale(.97);opacity:0}to{transform:scale(1);opacity:1}}
  #cIcon{display:flex; justify-content:center; margin:.3rem 0}
  #cIcon svg{max-width:160px}
  .qbadge{display:none; align-items:center; justify-content:center; gap:.4rem; margin:.4rem auto 0; width:max-content; padding:.2rem .6rem; border-radius:999px; font-weight:800; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.22)}
  .choices{display:flex; gap:1rem; justify-content:center; margin-top:1rem; flex-wrap: wrap;}
  .choice{min-width:200px; font-size:1.1rem; font-weight:900; border-radius:16px; padding:.9rem 1rem; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .positive{background:linear-gradient(180deg, var(--accent2), #1f8f4a)}
  .negative{background:linear-gradient(180deg, var(--danger), #9e1c2b)}

  #cc{margin:.6rem auto; max-width:1000px}
  #ccLive{background:var(--cc-bg); color:var(--cc-ink); border:2px solid var(--cc-border); border-radius:12px; padding:.6rem .8rem}
  #ccLog{margin-top:.4rem; max-height:140px; overflow:auto; font-size:.9rem; color:var(--muted)}

  /* --- √ÅLBUM MEJORADO --- */
  .album,.diary{margin:1rem auto; max-width:1000px}
  .cards-grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:1rem; margin-top: 1rem;}
  
  .game-card {
    background: linear-gradient(145deg, #1e2a4a, #162038);
    border: 2px solid var(--accent);
    border-radius: 16px;
    padding: 1rem;
    text-align: center;
    box-shadow: 0 8px 16px rgba(0,0,0,0.4);
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    overflow: hidden;
  }
  .game-card::before{ content:''; position: absolute; top:-50%; left:-50%; width:200%; height:200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.05), transparent); transform: rotate(45deg); pointer-events: none;}
  .game-card.locked {
    background: rgba(255,255,255,0.03);
    border: 2px dashed rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.3);
    box-shadow: none;
  }
  .game-card.locked .icon { opacity: 0.2; filter: grayscale(1); }
  .game-card h4 { margin: 0.5rem 0; font-size: 1.1rem; color: var(--accent); }
  .game-card.locked h4 { color: inherit; }
  .game-card p { font-size: 0.9rem; line-height: 1.4; margin: 0; color: var(--muted); }
  .game-card .status-icon { font-size: 2rem; margin-bottom: 0.5rem; }

  /* --- REWARD OVERLAY --- */
  .reward-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 10000;
    display: none; align-items: center; justify-content: center;
    opacity: 0; transition: opacity 0.3s; backdrop-filter: blur(5px);
  }
  .reward-overlay.active { display: flex; opacity: 1; pointer-events: auto; }
  .reward-content {
    background: var(--card); border: 2px solid var(--gold); border-radius: 20px;
    padding: 2rem; max-width: 400px; width: 90%; text-align: center;
    transform: scale(0.8); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 50px rgba(255, 197, 64, 0.2);
  }
  .reward-overlay.active .reward-content { transform: scale(1); }
  .reward-star { font-size: 4rem; margin: 0; text-shadow: 0 0 20px var(--gold); animation: spinPop 1s ease; display: block;}
  @keyframes spinPop { 0%{transform: scale(0) rotate(-180deg);} 70%{transform: scale(1.2) rotate(10deg);} 100%{transform: scale(1) rotate(0deg);} }
  .reward-card-display { margin: 1.5rem auto; transform: rotate(-2deg); }

  .diploma{display:none; text-align:center; margin:1rem auto}
  .diploma canvas{max-width:100%; border:3px solid var(--gold); border-radius:16px}

  /* Tutorial */
  .tut-overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-start; justify-content:center; z-index:9999; opacity:0; pointer-events:none; transition:opacity .2s}
  .tut-overlay.active{display:flex; opacity:1; pointer-events:auto}
  .tut-coach{margin-top:6vh; max-width:820px; background:var(--card); border:2px solid rgba(255,255,255,.25); border-radius:16px; padding:1rem}
  .tut-actions{display:flex; gap:.6rem; justify-content:flex-end; margin-top:.6rem}
  .highlight-ring{position:relative; z-index:9998; outline:4px solid var(--focus); outline-offset:2px; border-radius:12px}
</style>
</head>
<body>
  <header class="panel">
    <h1>El Arque√≥logo del Tiempo Digital</h1>
    <div class="toolbar">
      <button id="startBtn" class="btn btn-cta">üöÄ Reiniciar Expedici√≥n</button>
      <button id="tutorialBtn" class="btn btn-ghost" title="Tutorial guiado">üß≠ Tutorial</button>
      <div class="switch" aria-label="Energ√≠a"><strong>‚ö°</strong><span id="energyBar" style="display:inline-flex; gap:.25rem"></span></div>
    </div>
  </header>

  <div id="progressBar" class="progress-bar" role="status" aria-label="Progreso"></div>

  <main id="game" class="panel">
    <div id="grid" class="fossils" role="list" aria-label="F√≥siles"></div>

    <div id="chrono" class="panel" role="dialog" aria-modal="true" aria-labelledby="cTitle" aria-describedby="cDesc">
      <h2 id="cTitle">Visi√≥n del Futuro</h2>
      <div id="cIcon" aria-hidden="true"></div>
      <p id="cCause" style="font-size:1.1rem; color:#fff"></p>
      <p id="cDesc" style="color:var(--accent)"></p>
      <div id="qBadge" class="qbadge" aria-hidden="true">‚è≤Ô∏è <span id="qTime">12</span>s</div>
      
      <div id="decisionArea">
        <div class="choices" role="group" aria-label="Clasificar huella">
          <button class="choice positive" id="btnPos">üëç Huella Positiva <small style="display:block; font-weight:600; font-size:0.8em; opacity:0.9">(ayuda, construye)</small></button>
          <button class="choice negative" id="btnNeg">üëé Huella Negativa <small style="display:block; font-weight:600; font-size:0.8em; opacity:0.9">(riesgo, da√±a)</small></button>
        </div>
      </div>
      
      <div id="status" role="status" aria-live="polite" style="margin-top:1rem; min-height: 2rem;"></div>
      
      <!-- Zona de Reflexi√≥n (se inyecta din√°micamente) -->
      <div id="reflectionArea" style="display:none; margin-top:1rem; border-top:1px solid rgba(255,255,255,0.1); padding-top:1rem;"></div>
    </div>
  </main>

  <section id="cc" aria-label="Subt√≠tulos">
    <div id="ccLive" aria-live="polite">‚Äî</div>
  </section>

  <!-- SECCI√ìN √ÅLBUM MEJORADA -->
  <section class="panel album" id="albumSection">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <h2>üìö √Ålbum de Conocimiento</h2>
      <span id="albumCount" style="background:var(--accent); color:#000; padding:2px 8px; border-radius:10px; font-weight:bold">0/4</span>
    </div>
    <div class="cards-grid" id="albumCards">
      <!-- Se llenar√° con JS -->
    </div>
  </section>

  <section class="diploma" id="diplomaSection">
    <h2>üèÜ Diploma</h2>
    <canvas id="diplomaCanvas" width="900" height="560" aria-label="Diploma"></canvas>
    <p><button id="downloadDiploma" class="btn btn-cta">Descargar Diploma</button></p>
  </section>

  <!-- OVERLAY DE RECOMPENSA (CARTA) -->
  <div class="reward-overlay" id="rewardOverlay">
    <div class="reward-content">
      <div class="reward-star">üåü</div>
      <h2 style="color:var(--gold); margin:0.5rem 0;">¬°Excelente Trabajo!</h2>
      <p>Has entendido la conexi√≥n y completado el an√°lisis.</p>
      
      <div id="rewardCardContainer" class="reward-card-display">
        <!-- Aqu√≠ se clona la carta ganada -->
      </div>

      <button id="collectCardBtn" class="btn btn-cta" style="font-size:1.2rem; width:100%; box-shadow: 0 4px 15px var(--accent);">
        üì• Guardar en el √Ålbum
      </button>
    </div>
  </div>

  <!-- Overlay Tutorial -->
  <div class="tut-overlay" id="tutOverlay" role="dialog" aria-modal="true" aria-labelledby="tutTitle" tabindex="-1">
    <div class="tut-coach">
      <h2 id="tutTitle">üß≠ Tutorial guiado</h2>
      <div id="tutDesc"></div>
      <div class="tut-actions">
        <button class="btn btn-ghost" id="tutSkip">Saltar</button>
        <button class="btn btn-cta" id="tutNext">Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

<script>
/******** Datos ********/
const BASE_FOSILES=[
 {id:'comentario', titulo:'El Comentario Enojado', tipo:'Comentario', causa:'Comentario: ‚Äú¬°Perdimos por tu culpa, Leo!‚Äù', consecuencia:'Leo abandona el equipo muy triste.', correcta:'negativo', pistas:['¬øAyuda o hiere al equipo?','Las palabras escritas permanecen.','Regla: Trata como quieres ser tratado.'], cardTitle:'Respeto Digital', cardText:'Tus palabras tienen poder. Si est√°s enojado, espera antes de escribir. Una disculpa a tiempo puede arreglarlo.'},
 {id:'foto', titulo:'La Foto Graciosa', tipo:'Foto', causa:'Foto de Alex en pijama con burlas.', consecuencia:'Un club escolar lo rechaza por "inmaduro".', correcta:'negativo', pistas:['¬øTe gustar√≠a que todos lo vieran?','Afecta tu reputaci√≥n futura.','No publiques para ridiculizar.'], cardTitle:'Imagen P√∫blica', cardText:'Lo que subes hoy construye qui√©n eres ma√±ana. Pide permiso antes de subir fotos de otros.'},
 {id:'post', titulo:'El Agradecimiento', tipo:'Post', causa:'Post p√∫blico agradeciendo ayuda a Sara.', consecuencia:'Sara sonr√≠e y la amistad mejora.', correcta:'positivo', pistas:['¬øCrea confianza?','La gratitud p√∫blica es poderosa.','Genera un ambiente positivo.'], cardTitle:'Huella Positiva', cardText:'Internet tambi√©n sirve para cosas buenas. Agradecer y apoyar crea una comunidad segura.'},
 {id:'ubicacion', titulo:'Ubicaci√≥n Exacta', tipo:'Ubicaci√≥n', causa:'Foto etiquetada en "Parque Aventura" ahora.', consecuencia:'Un desconocido rastrea sus rutinas.', correcta:'negativo', pistas:['¬øEs seguro decir d√≥nde est√°s ya?','Muestra tus rutinas a extra√±os.','Publica la foto DESPU√âS de irte.'], cardTitle:'Seguridad Real', cardText:'Nunca compartas tu ubicaci√≥n en tiempo real p√∫blicamente. Hazlo en privado o cuando ya te hayas ido.'}
];

/******** Estado ********/
const LS_COLLECTED='ecos_collected_ids'; 
let orden=[], aciertos=0, intentos=[], current=null, energy=3, narrationOn=true;
let tutorialMode=false, tutorialStep=0;
let collectedCards = []; // IDs de las cartas conseguidas

/******** Voz + CC ********/
function cc(text){ const live=document.getElementById('ccLive'); if(live) live.textContent=text; }
function speakBase(prefix, text){ const full=`${prefix}${text}`; cc(full); if(!narrationOn||!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(full); u.lang='es-MX'; try{ speechSynthesis.cancel(); }catch{} speechSynthesis.speak(u); }
const speakGuardian=(t)=>speakBase('Guardi√°n: ', t);
const speakSystem=(t)=>speakBase('', t);

/******** Gr√°ficos SVG ********/
function iconForTypeSVG(tipo, size=56){
  const common=(b)=>`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='${size}' height='${size}' role='img' aria-label='${tipo}' style='color:inherit'>${b}</svg>`;
  if(tipo==='Comentario') return common(`<rect x='10' y='20' rx='14' width='100' height='70' fill='var(--chip-chat)'></rect><circle cx='28' cy='50' r='6' fill='#fff'/><circle cx='48' cy='50' r='6' fill='#fff'/><circle cx='68' cy='50' r='6' fill='#fff'/><path d='M30 90 L20 110 L48 92' fill='var(--chip-chat)'/>`);
  if(tipo==='Foto') return common(`<rect x='14' y='24' rx='10' width='92' height='72' fill='var(--chip-foto)'></rect><circle cx='44' cy='50' r='10' fill='#fff'/><path d='M34 78 L54 58 L72 72 L86 60 L100 78 Z' fill='#fff'/>`);
  if(tipo==='Post') return common(`<rect x='16' y='24' rx='10' width='88' height='72' fill='var(--chip-post)'></rect><rect x='28' y='40' width='64' height='10' rx='5' fill='#fff'/><rect x='28' y='58' width='48' height='10' rx='5' fill='#fff'/><path d='M90 84 a10 10 0 1 1 -20 0 a10 10 0 1 1 20 0' fill='#fff'/>`);
  return common(`<rect x='20' y='20' rx='12' width='80' height='80' fill='var(--chip-ubi)'></rect><path d='M60 36a18 18 0 0 0-18 18c0 14 18 36 18 36s18-22 18-36A18 18 0 0 0 60 36zm0 12a6 6 0 1 1 0 12 6 6 0 0 1 0-12z' fill='#fff'/>`);
}

/******** Renderizado UI ********/
function setEnergy(e){ energy=Math.max(0,Math.min(3,e)); const bar=document.getElementById('energyBar'); if(!bar) return; bar.innerHTML=''; for(let i=0;i<3;i++){const b=document.createElement('span'); b.style.width='18px';b.style.height='26px';b.style.display='inline-block';b.style.clipPath='polygon(45% 0, 60% 0, 40% 40%, 65% 40%, 25% 100%, 40% 60%, 15% 60%)'; b.style.background=i<energy?'var(--accent2)':'#6d7fb0'; b.style.border='2px solid '+(i<energy?'#1d6b32':'#3b4a7a'); bar.appendChild(b);} }

function renderProgress(){ const bar=document.getElementById('progressBar'); bar.innerHTML=''; orden.forEach((idx,i)=>{ const dot=document.createElement('div'); dot.className='progress-dot pending'; dot.id='dot'+i; bar.appendChild(dot); }); }

function renderGrid(){ 
  const grid=document.getElementById('grid'); grid.innerHTML=''; 
  orden.forEach((idx,i)=>{ 
    const f=BASE_FOSILES[idx]; 
    const isSolved = collectedCards.includes(f.id);
    const btn=document.createElement('button'); 
    btn.className='fossil' + (isSolved ? ' solved' : ''); 
    btn.disabled = isSolved;
    btn.innerHTML=`<div class="icon">${iconForTypeSVG(f.tipo)}</div><div><span class="chip chip--${f.tipo}">${f.tipo}</span><h3>${f.titulo}</h3><p><strong>Estado:</strong> ${isSolved ? '‚úÖ Completado' : '‚ùì Investigar'}</p></div>`; 
    btn.onclick=()=>mostrarFosil(i); 
    grid.appendChild(btn); 
  }); 
}

/* --- L√ìGICA DEL √ÅLBUM VISUAL --- */
function renderAlbum(){ 
  // Recuperar cartas guardadas
  try { collectedCards = JSON.parse(localStorage.getItem(LS_COLLECTED) || '[]'); } catch(e){ collectedCards=[]; }
  
  const box=document.getElementById('albumCards'); 
  box.innerHTML='';
  document.getElementById('albumCount').textContent = `${collectedCards.length}/4`;

  BASE_FOSILES.forEach(f => {
    const isUnlocked = collectedCards.includes(f.id);
    const cardDiv = document.createElement('div');
    cardDiv.className = `game-card ${isUnlocked ? 'unlocked' : 'locked'}`;
    
    if(isUnlocked){
      cardDiv.innerHTML = `
        <div class="icon" style="color:var(--ink)">${iconForTypeSVG(f.tipo, 48)}</div>
        <h4>${f.cardTitle}</h4>
        <p>${f.cardText}</p>
      `;
    } else {
      cardDiv.innerHTML = `
        <div class="status-icon">üîí</div>
        <h4>Bloqueado</h4>
        <p>Resuelve el caso "${f.titulo}" para ver esta carta.</p>
      `;
    }
    box.appendChild(cardDiv);
  });
}

/******** Flujo del Juego ********/
function iniciar(){
  orden=BASE_FOSILES.map((_,i)=>i); 
  // No aleatorizamos orden para simplificar debug, descomentar si se desea:
  // orden.sort(() => Math.random() - 0.5);
  
  intentos=Array(orden.length).fill(0); 
  aciertos=0; current=null; setEnergy(3);
  
  // Limpiar colecci√≥n al iniciar partida nueva si se desea, o mantener progreso:
  // collectedCards = []; localStorage.setItem(LS_COLLECTED, '[]'); 
  // *Para este demo, mantenemos progreso entre recargas, pero bot√≥n inicio limpia sesi√≥n visual actual*
  
  renderAlbum(); // Dibuja el estado actual
  renderProgress(); 
  renderGrid(); 
  
  document.getElementById('diplomaSection').style.display='none'; 
  document.getElementById('chrono').style.display='none';
  if(!tutorialMode && collectedCards.length < 4) speakGuardian('Bienvenido Arque√≥logo. Tienes f√≥siles pendientes por analizar.');
  if(collectedCards.length === 4) finalizar();
}

/******** Cronoscopio ********/
function mostrarFosil(i){ 
  current=i; 
  const f=BASE_FOSILES[orden[i]]; 
  const ch=document.getElementById('chrono'); 
  ch.classList.add('active'); ch.style.display='block'; 
  
  // Resetear vista del cronoscopio
  document.getElementById('cTitle').textContent=f.titulo; 
  document.getElementById('cCause').textContent='Causa: '+f.causa; 
  document.getElementById('cDesc').textContent='Consecuencia: '+f.consecuencia; 
  document.getElementById('cIcon').innerHTML=iconForTypeSVG(f.tipo, 100); 
  document.getElementById('status').textContent='Analiza: ¬øEsto fue positivo o negativo?';
  
  document.getElementById('decisionArea').style.display = 'block';
  document.getElementById('reflectionArea').style.display = 'none';
  document.getElementById('reflectionArea').innerHTML = '';
  
  document.getElementById('grid').scrollIntoView({behavior:'smooth'});
  speakGuardian('He activado el Cronoscopio. Mira la consecuencia.'); 
}

function clasificar(resp){ 
  if(current==null) return; 
  const f=BASE_FOSILES[orden[current]]; 
  const correcto=(resp===f.correcta); 
  const dot=document.getElementById('dot'+current); 

  if(correcto){ 
    // √âXITO
    if(dot) dot.className='progress-dot correct'; 
    setEnergy(Math.min(3, energy+1)); 
    speakSystem('¬°Correcto! Entendiste la relaci√≥n.');
    
    // Ocultar botones de decisi√≥n y mostrar reflexi√≥n
    document.getElementById('decisionArea').style.display = 'none';
    const refArea = document.getElementById('reflectionArea');
    refArea.style.display = 'block';
    
    // Generar opciones de reflexi√≥n
    const optAText = f.id==='comentario'?'Pedir disculpas y hablarlo en persona': f.id==='foto'?'Pedir permiso antes de subirla': f.id==='post'?'Agradecer con respeto':'Compartir la ubicaci√≥n al salir del lugar';
    const optBText = f.id==='comentario'?'Bloquear a todos': f.id==='foto'?'Borrarla y no decir nada': f.id==='post'?'Pedirle dinero':'No decir nunca d√≥nde est√°s';
    
    refArea.innerHTML = `
      <p><strong>Reflexi√≥n Final:</strong> ¬øQu√© acci√≥n construir√° un mejor futuro?</p>
      <div style='display:flex;gap:.5rem;justify-content:center;flex-wrap:wrap'>
        <button class='choice positive' id='refA' style="font-size:0.9rem; padding:0.6rem">${optAText}</button>
        <button class='choice negative' id='refB' style="font-size:0.9rem; padding:0.6rem; opacity:0.7">${optBText}</button>
      </div>
    `;

    // Ambas opciones llevan a la recompensa (el aprendizaje es la selecci√≥n previa)
    // pero la UI sugiere la correcta con colores.
    document.getElementById('refA').onclick = () => triggerReward(f);
    document.getElementById('refB').onclick = () => triggerReward(f);
    
    document.getElementById('status').innerHTML = "¬°Excelente! Ahora elige la mejor acci√≥n para cerrar el caso.";

  } else { 
    // ERROR
    if(dot) dot.className='progress-dot retry'; 
    setEnergy(energy-1); 
    const pista = f.pistas[intentos[current] % f.pistas.length];
    intentos[current]++;
    document.getElementById('status').innerHTML=`‚ùå Pi√©nsalo bien. <br><span style="color:var(--focus)">Pista: ${pista}</span>`; 
    speakSystem('Int√©ntalo de nuevo. ' + pista); 
  }
}

/* --- SISTEMA DE RECOMPENSAS --- */
function triggerReward(fossilData){
  // 1. Cerrar Cronoscopio
  document.getElementById('chrono').classList.remove('active');
  document.getElementById('chrono').style.display='none';

  // 2. Preparar Overlay
  const overlay = document.getElementById('rewardOverlay');
  const cardContainer = document.getElementById('rewardCardContainer');
  
  // Crear visualmente la carta para el overlay
  cardContainer.innerHTML = `
    <div class="game-card" style="width:220px; margin:0 auto; transform:scale(1.1); box-shadow:0 10px 30px rgba(0,0,0,0.5)">
      <div class="icon" style="color:#fff">${iconForTypeSVG(fossilData.tipo, 60)}</div>
      <h4 style="color:var(--accent); font-size:1.3rem; margin:0.5rem 0">${fossilData.cardTitle}</h4>
      <p style="color:#ddd">${fossilData.cardText}</p>
    </div>
  `;

  // 3. Mostrar Overlay
  overlay.classList.add('active');
  speakGuardian('¬°Magn√≠fico! Has desbloqueado una nueva tarjeta de sabidur√≠a.');
  
  // Configurar el bot√≥n "Guardar"
  const btn = document.getElementById('collectCardBtn');
  btn.onclick = () => {
    collectCard(fossilData.id);
  };
  btn.focus();
}

function collectCard(id){
  // 1. Guardar datos
  if(!collectedCards.includes(id)){
    collectedCards.push(id);
    localStorage.setItem(LS_COLLECTED, JSON.stringify(collectedCards));
  }
  
  // 2. Ocultar Overlay
  document.getElementById('rewardOverlay').classList.remove('active');
  
  // 3. Actualizar UI
  renderAlbum();
  renderGrid(); // Bloquea el f√≥sil completado
  
  // 4. Scroll al √°lbum para feedback visual
  document.getElementById('albumSection').scrollIntoView({behavior:'smooth'});
  speakSystem('Tarjeta guardada en el √°lbum.');

  // 5. Verificar victoria
  if(collectedCards.length === BASE_FOSILES.length){
    setTimeout(finalizar, 1500);
  }
}

function finalizar(){
  speakGuardian('¬°Misi√≥n cumplida! Has completado el √Ålbum de Ecos y eres un experto.'); 
  mostrarDiploma();
  document.getElementById('diplomaSection').scrollIntoView({behavior:'smooth'});
}

/* --- DIPLOMA --- */
function mostrarDiploma(){ 
  const section=document.getElementById('diplomaSection'); section.style.display='block'; 
  const canvas=document.getElementById('diplomaCanvas'); const ctx=canvas.getContext('2d'); 
  
  // Fondo
  ctx.fillStyle='#fff8e1'; ctx.fillRect(0,0,canvas.width,canvas.height); 
  ctx.strokeStyle='#fbc02d'; ctx.lineWidth=15; ctx.strokeRect(20,20,canvas.width-40,canvas.height-40); 
  
  // Texto
  ctx.fillStyle='#222'; ctx.font='bold 40px Arial'; ctx.textAlign='center';
  ctx.fillText('CERTIFICADO DE EXCELENCIA', canvas.width/2, 120); 
  
  ctx.font='30px Arial';
  ctx.fillText('Se otorga el t√≠tulo de:', canvas.width/2, 180); 
  
  ctx.fillStyle='#2B7EA7'; ctx.font='bold 50px Arial';
  ctx.fillText('ARQUE√ìLOGO/A DIGITAL', canvas.width/2, 250); 
  
  ctx.fillStyle='#555'; ctx.font='24px Arial';
  ctx.fillText('Por comprender que cada huella deja un eco en el futuro.', canvas.width/2, 320); 
  
  // Estrellas
  ctx.fillStyle='#fbc02d';
  for(let i=0; i<4; i++){
    let x = 350 + (i*70);
    drawStar(ctx, x, 400, 20, 5, 2);
  }
  
  const date=new Date().toLocaleDateString(); 
  ctx.font='20px Arial'; ctx.fillStyle='#888';
  ctx.fillText('Fecha: '+date,canvas.width/2, 500); 
}

function drawStar(ctx,x,y,r,n,inset){
  ctx.save(); ctx.beginPath(); ctx.translate(x,y); ctx.moveTo(0,0-r);
  for(let i=0;i<n;i++){ ctx.rotate(Math.PI/n); ctx.lineTo(0,0-(r/inset)); ctx.rotate(Math.PI/n); ctx.lineTo(0,0-r); }
  ctx.fill(); ctx.restore();
}

/* --- TUTORIAL --- */
const TSTEPS=[
  {txt:'¬°Hola! Soy el Guardi√°n. Te ense√±ar√© a rastrear huellas digitales.', act:()=>{}},
  {sel:'#grid', txt:'Aqu√≠ est√°n los f√≥siles digitales. Elige uno para investigar.', act:()=>{}},
  {sel:'#albumSection', txt:'Tu objetivo es desbloquear las 4 tarjetas del √Ålbum.', act:()=>{document.getElementById('albumSection').scrollIntoView()}},
  {sel:null, txt:'¬°Comencemos! Elige un f√≥sil y usa el Cronoscopio.', act:()=>{document.getElementById('game').scrollIntoView()}}
];
function runTutorial(){
  tutorialMode=true;
  const overlay=document.getElementById('tutOverlay');
  const title=document.getElementById('tutTitle');
  const desc=document.getElementById('tutDesc');
  const btnNext=document.getElementById('tutNext');
  
  let step=0;
  overlay.classList.add('active');
  
  const show=()=>{
    const s=TSTEPS[step];
    desc.textContent=s.txt;
    document.querySelectorAll('.highlight-ring').forEach(e=>e.classList.remove('highlight-ring'));
    if(s.sel){
      const el=document.querySelector(s.sel);
      if(el) { el.classList.add('highlight-ring'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
    }
    if(s.act) s.act();
    btnNext.textContent = step===TSTEPS.length-1 ? 'Jugar' : 'Siguiente';
  };
  
  show();
  
  btnNext.onclick=()=>{
    step++;
    if(step>=TSTEPS.length){ 
      tutorialMode=false; overlay.classList.remove('active'); 
      document.querySelectorAll('.highlight-ring').forEach(e=>e.classList.remove('highlight-ring'));
    } else { show(); }
  };
  document.getElementById('tutSkip').onclick=()=>{
      tutorialMode=false; overlay.classList.remove('active');
      document.querySelectorAll('.highlight-ring').forEach(e=>e.classList.remove('highlight-ring'));
  };
}

/******** Listeners ********/
document.getElementById('btnPos').onclick=()=>clasificar('positivo');
document.getElementById('btnNeg').onclick=()=>clasificar('negativo');
document.getElementById('startBtn').onclick=()=>{ 
  if(confirm('¬øReiniciar todo el progreso?')){
    localStorage.removeItem(LS_COLLECTED);
    iniciar(); 
  }
};
document.getElementById('tutorialBtn').onclick=()=>runTutorial();
document.getElementById('downloadDiploma').onclick=()=>{ 
  const link=document.createElement('a'); link.download='diploma-ecos.png'; 
  link.href=document.getElementById('diplomaCanvas').toDataURL(); link.click(); 
};

// Arranque
renderAlbum();
if(collectedCards.length < 4) iniciar(); else { renderGrid(); finalizar(); }

</script>
</body>
</html>
