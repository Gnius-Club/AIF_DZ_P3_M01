<!DOCTYPE html>
<html lang="es" translate="no">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="theme-color" content="#0A0F1F" />
<title>El Arque√≥logo del Tiempo Digital: Ecos del Futuro</title>
<link rel="manifest" href="data:application/manifest+json,{\"name\":\"Ecos del Futuro\",\"short_name\":\"Ecos\",\"start_url\":\".\",\"display\":\"standalone\",\"background_color\":\"#0A0F1F\",\"theme_color\":\"#0A0F1F\"}" />
<style>
  /* =================== Paleta con contraste mejorado (AA aprox) =================== */
  :root{
    --bg:#0A0F1F;        /* fondo oscuro profundo */
    --bg2:#101a34;       /* degradado */
    --card:#111A33;      /* paneles */
    --ink:#FFFFFF;       /* texto principal */
    --muted:#D7E3FF;     /* texto secundario */
    --accent:#2FD0FF;    /* cta / detalles */
    --accent2:#39E06C;   /* correcto */
    --danger:#E64556;    /* error */
    --gold:#FFC540;      /* diploma */
    --focus:#FFF176;     /* foco accesible */

    --chip-chat:#2B7EA7; /* chips OSCUROS para texto claro */
    --chip-foto:#B88600;
    --chip-post:#2C8C4A;
    --chip-ubi:#B04A35;

    --cc-bg:rgba(0,0,0,.6); /* subt√≠tulos en oscuro */
    --cc-ink:#FFFFFF;
    --cc-border:rgba(255,255,255,.35);
  }
  /* Tema claro "Ni√±os Solar" con buen contraste */
  body.solar-theme{
    --bg:#FFF7DA; --bg2:#FFE9A8; --card:#FFF3BD; --ink:#1A1A1A; --muted:#333333;
    --accent:#0077B6; --accent2:#188A42; --danger:#B71C1C; --gold:#C49000; --focus:#000000;
    --chip-chat:#90CAF9; --chip-foto:#FFE082; --chip-post:#C8E6C9; --chip-ubi:#FFCCBC;
    --cc-bg:rgba(255,255,255,.9); --cc-ink:#111; --cc-border:rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
    background: radial-gradient(1200px 600px at 70% 0%, var(--bg2), var(--bg));
    color:var(--ink);
  }
  .visually-hidden{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  button{border:0; cursor:pointer}
  button:focus-visible{outline:4px solid var(--focus); outline-offset:3px}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:1rem}

  header.panel{display:flex; gap:1rem; align-items:center; justify-content:space-between; flex-wrap:wrap}
  header h1{margin:.2rem 0; font-size:clamp(1.4rem, 2.2vw + 1rem, 2.4rem)}
  .toolbar{display:flex; gap:.6rem; align-items:center; flex-wrap:wrap}
  .btn{font-weight:800; border-radius:14px; padding:.6rem 1rem}
  .btn-cta{background:linear-gradient(180deg, var(--accent), #0da1d1)}
  .btn-ghost{background:transparent; color:var(--ink); border:2px solid var(--accent)}
  /* Texto de botones seg√∫n tema */
  body:not(.solar-theme) .btn-cta{ color:#FFFFFF; }
  body.solar-theme .btn-cta{ color:#00131a; }

  .switch{display:flex; align-items:center; gap:.4rem; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); padding:.35rem .6rem; border-radius:12px; color:var(--ink)}
  .switch input{accent-color:var(--accent)}

  /* Progreso visual */
  .progress-bar{display:flex; gap:.6rem; justify-content:center; margin:.5rem auto; padding:.4rem .8rem}
  .progress-dot{width:20px; height:20px; border-radius:50%; background:#6d7fb0; border:2px solid #3b4a7a}
  .progress-dot.correct{background:var(--accent2); border-color:#1d6b32}
  .progress-dot.retry{background:var(--danger); border-color:#6b1220}

  /* Grid f√≥siles */
  .fossils{display:grid; grid-template-columns:repeat(2,minmax(240px,1fr)); gap:1.2rem; padding:1.2rem}
  .fossil{background:var(--card); border-radius:18px; padding:1rem; text-align:left; display:flex; gap:.8rem; align-items:center; transition:transform .12s ease, box-shadow .2s ease; box-shadow:0 10px 18px rgba(0,0,0,.35); color:var(--ink)}
  .fossil:hover{transform:translateY(-2px); box-shadow:0 14px 24px rgba(0,0,0,.4)}
  .fossil .icon{width:56px; height:56px; flex:0 0 56px; color:var(--ink)}
  .fossil h3{margin:.15rem 0 .25rem 0; font-size:1.05rem; color:var(--ink)}
  .fossil p{margin:0; color:var(--muted)}
  .chip{display:inline-block; padding:.25rem .6rem; border-radius:12px; font-size:.8rem; margin-bottom:.25rem; font-weight:800}
  /* Texto de chips: blanco en oscuro, oscuro en solar */
  body:not(.solar-theme) .chip{ color:#FFFFFF; }
  body.solar-theme .chip{ color:#111111; }
  .chip--Comentario{background:var(--chip-chat)}
  .chip--Foto{background:var(--chip-foto)}
  .chip--Post{background:var(--chip-post)}
  .chip--Ubicaci√≥n{background:var(--chip-ubi)}

  /* Cronoscopio */
  #chrono{display:none; margin-top:1rem}
  #chrono.active{display:block; animation:zoomIn .35s ease}
  @keyframes zoomIn{from{transform:scale(.97); opacity:0} to{transform:scale(1); opacity:1}}
  #cIcon{width:100%; display:flex; justify-content:center; margin:.3rem 0}
  #cIcon svg{max-width:160px}
  .choices{display:flex; gap:1rem; justify-content:center; margin-top:1rem}
  .choice{min-width:240px; font-size:1.1rem; font-weight:900; border-radius:16px; padding:.9rem 1rem; color:#fff; text-shadow:0 1px 0 rgba(0,0,0,.35)}
  .positive{background:linear-gradient(180deg, var(--accent2), #1f8f4a)}
  .negative{background:linear-gradient(180deg, var(--danger), #9e1c2b)}

  /* Subt√≠tulos / CC */
  #cc{margin:.6rem auto; max-width:1000px}
  #ccLive{background:var(--cc-bg); color:var(--cc-ink); border:2px solid var(--cc-border); border-radius:12px; padding:.6rem .8rem; font-size:1rem}
  #ccLog{margin-top:.4rem; max-height:140px; overflow:auto; font-size:.9rem; color:var(--muted)}

  /* Diploma */
  .diploma{display:none; text-align:center; margin:1rem auto}
  .diploma canvas{max-width:100%; border:3px solid var(--gold); border-radius:16px}

  /* √Ålbum/Diario */
  .album{margin:1rem auto; max-width:1000px}
  .cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.8rem}
  .card-know{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:.6rem; color:var(--ink)}
  .card-know h4{margin:.2rem 0; color:var(--ink)}

  .diary{margin:1rem auto; max-width:1000px; color:var(--ink)}
  details{background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); border-radius:12px; padding:.6rem .8rem}
  summary{cursor:pointer; font-weight:800}
  table{width:100%; border-collapse:collapse; margin-top:.5rem}
  th, td{padding:.5rem .6rem; border-bottom:1px solid rgba(255,255,255,.18); text-align:left}
  th{color:var(--ink)}
  tr:nth-child(even){background:rgba(255,255,255,.04)}

  /* =================== Tutorial guiado =================== */
  .tut-overlay{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:flex-start; justify-content:center; z-index:9999; opacity:0; pointer-events:none; transition:opacity .2s ease}
  .tut-overlay.active{display:flex; opacity:1; pointer-events:auto}
  .tut-coach{margin-top:6vh; max-width:820px; background:var(--card); color:var(--ink); border:2px solid rgba(255,255,255,.25); border-radius:16px; padding:1rem; box-shadow:0 20px 40px rgba(0,0,0,.45)}
  .tut-actions{display:flex; gap:.6rem; justify-content:flex-end; margin-top:.6rem}
  .highlight-ring{position:relative; z-index:9998; outline:4px solid var(--focus); outline-offset:2px; border-radius:12px}
  .tut-note{font-size:.95rem; color:var(--muted)}
</style>
</head>
<body>
  <header class="panel" role="banner">
    <h1>El Arque√≥logo del Tiempo Digital: Ecos del Futuro</h1>
    <div class="toolbar" role="group" aria-label="Controles">
      <button id="startBtn" class="btn btn-cta" aria-describedby="hint">üöÄ Comenzar expedici√≥n</button>
      <button id="tutorialBtn" class="btn btn-ghost" title="Tutorial guiado">üß≠ Tutorial</button>
      <button id="challengeToggle" class="btn btn-ghost" aria-pressed="false" title="Modo Reto 90s">‚è±Ô∏è Modo Reto</button>
      <div class="switch"><label for="narrationToggle">Voz en off</label><input id="narrationToggle" type="checkbox" checked aria-label="Activar o desactivar voz en off"></div>
      <div class="switch"><label for="themeToggle">Tema</label><button id="themeToggle" class="btn btn-ghost" aria-pressed="false">üåû Alternar tema</button></div>
      <div class="switch" aria-label="Tiempo restante"><strong>‚è≥</strong> <span id="timer">‚Äî</span></div>
      <div class="switch" aria-label="Energ√≠a Cronoscopio"><strong>‚ö°</strong><span id="energyBar" style="display:inline-flex; gap:.25rem"></span></div>
      <span id="hint" class="visually-hidden">Usa flechas para elegir y Enter para confirmar.</span>
    </div>
  </header>

  <div class="progress-bar" id="progressBar" role="status" aria-label="Progreso por f√≥sil"></div>

  <main id="game" class="panel" role="main">
    <div id="grid" class="fossils" role="list" aria-label="F√≥siles digitales"></div>

    <div id="chrono" class="panel" role="dialog" aria-modal="true" aria-labelledby="cTitle" aria-describedby="cDesc">
      <h2 id="cTitle">Visi√≥n del Futuro</h2>
      <div id="cIcon" aria-hidden="true"></div>
      <p id="cCause"></p>
      <p id="cDesc"></p>
      <div class="choices" role="group" aria-label="Clasificar huella">
        <button class="choice positive" id="btnPos">üëç Huella Positiva <small style="display:block; font-weight:600">(ayuda, respeto)</small></button>
        <button class="choice negative" id="btnNeg">üëé Huella Negativa <small style="display:block; font-weight:600">(riesgo, da√±o)</small></button>
      </div>
      <div id="status" role="status" aria-live="polite" style="margin-top:.5rem"></div>
    </div>
  </main>

  <section id="cc" aria-label="Subt√≠tulos">
    <div id="ccLive" aria-live="polite">‚Äî</div>
    <div id="ccLog" aria-live="off"></div>
  </section>

  <section class="panel album" id="albumSection">
    <h2>üìö √Ålbum de Conocimiento</h2>
    <div class="cards" id="albumCards"></div>
  </section>

  <section class="panel diary" id="diarySection">
    <h2>üìù Diario de Ecos</h2>
    <div id="diaryWrap"></div>
  </section>

  <section class="diploma" id="diplomaSection" aria-live="polite">
    <h2>üèÜ Diploma</h2>
    <canvas id="diplomaCanvas" width="900" height="560" aria-label="Diploma: Arque√≥logo/a de la Sabidur√≠a"></canvas>
    <p><button id="downloadDiploma" class="btn btn-cta">Descargar Diploma</button></p>
  </section>

  <!-- Overlay de Tutorial Guiado -->
  <div class="tut-overlay" id="tutOverlay" role="dialog" aria-modal="true" aria-labelledby="tutTitle" aria-describedby="tutDesc" tabindex="-1">
    <div class="tut-coach">
      <h2 id="tutTitle">üß≠ Tutorial guiado</h2>
      <div id="tutDesc"></div>
      <p class="tut-note">Puedes usar <strong>Tab</strong> para moverte y <strong>Enter</strong> para continuar. <em>(El tutorial simula acciones sin guardar tu progreso real)</em>.</p>
      <div class="tut-actions">
        <button class="btn btn-ghost" id="tutSkip">Saltar</button>
        <button class="btn btn-cta" id="tutPrev">‚Üê Atr√°s</button>
        <button class="btn btn-cta" id="tutNext">Siguiente ‚Üí</button>
      </div>
    </div>
  </div>

<script>
/********************* Datos del juego con pistas y tarjetas *********************/
const BASE_FOSILES = [
  {id:'comentario', titulo:'El Comentario Enojado', tipo:'Comentario', causa:'Comentario ‚Äú¬°Perdimos por tu culpa, Leo! ¬°Eres el peor!‚Äù', consecuencia:'Leo se entristece y deja el chat del equipo.', correcta:'negativo', pistas:[
    'Pista 1: Observa c√≥mo se siente la otra persona tras el mensaje.',
    'Pista 2: Un comentario hiriente da√±a el trabajo en equipo.',
    'Regla de oro: Trata a los dem√°s como quieres que te traten.'
  ], card:'Usa un lenguaje respetuoso, incluso cuando est√©s molesto.'},
  {id:'foto', titulo:'La Foto Graciosa en Pijama', tipo:'Foto', causa:'Foto de Alex en pijama de dinosaurio con burla ‚Äú¬°Qu√© rid√≠culo!‚Äù', consecuencia:'Un reclutador escolar decide no invitarlo a un club.', correcta:'negativo', pistas:[
    'Pista 1: Las burlas p√∫blicas permanecen en la red.',
    'Pista 2: Las fotos pueden afectar oportunidades futuras.',
    'Regla de oro: No publiques fotos para ridiculizar a alguien.'
  ], card:'Piensa antes de publicar: ¬øc√≥mo se ver√° esta foto en el futuro?'},
  {id:'post', titulo:'El Post de Agradecimiento', tipo:'Post', causa:'Publicaci√≥n agradeciendo a Sara por ayudar con la tarea.', consecuencia:'Sara sonr√≠e y fortalece su amistad con Alex.', correcta:'positivo', pistas:[
    'Pista 1: ¬øEsta acci√≥n mejora una amistad?',
    'Pista 2: Reconocer el apoyo crea confianza.',
    'Regla de oro: Difunde gratitud y respeto.'
  ], card:'La gratitud p√∫blica crea una huella positiva.'},
  {id:'ubicacion', titulo:'La Ubicaci√≥n Compartida', tipo:'Ubicaci√≥n', causa:'Foto en ‚ÄúParque Aventura‚Äù con ubicaci√≥n p√∫blica.', consecuencia:'Un Robadatos identifica el lugar que frecuenta Alex.', correcta:'negativo', pistas:[
    'Pista 1: Compartir ubicaci√≥n muestra tus rutinas.',
    'Pista 2: Desconocidos podr√≠an encontrarte all√≠.',
    'Regla de oro: Evita publicar ubicaci√≥n en tiempo real.'
  ], card:'No publiques tu ubicaci√≥n en tiempo real.'}
];

/********************* Estado de juego y sesi√≥n *********************/
const LS_ALBUM_KEY='ecos_album_v1';
const LS_DIARY_KEY='ecos_diario_v2';
let orden=[]; let aciertos=0; let intentos=[]; let current=null; let energy=3; let reto=false; let tiempo=0, ticker=null; let narrationOn=true; let startedAt=null; let bonusEstrellas=0;
let currentSession=null;

/********************* Tutorial (estado) *********************/
let tutorialMode=false; let tutorialStep=0;

/********************* Subt√≠tulos y Voz *********************/
function cc(text){ const live=document.getElementById('ccLive'); const log=document.getElementById('ccLog'); if(!live||!log) return; live.textContent=text; const stamp=new Date().toLocaleTimeString(); const div=document.createElement('div'); div.textContent=`[${stamp}] ${text}`; log.prepend(div); }
function getSpanishVoice(){ const voices=speechSynthesis.getVoices()||[]; return voices.find(v=>/es|spa/i.test(v.lang) && /mex|lat|es-/i.test(v.lang)) || voices.find(v=>/es|spa/i.test(v.lang)) || null; }
function speakBase(prefix, text, {rate=1, pitch=1}={}){ const full=`${prefix}${text}`; cc(full); if(!narrationOn || !('speechSynthesis' in window)){ try{ if(navigator.vibrate) navigator.vibrate([30,50]); }catch{} return; } const u=new SpeechSynthesisUtterance(full); u.lang='es-MX'; u.rate=rate; u.pitch=pitch; const v=getSpanishVoice(); if(v) u.voice=v; try{ speechSynthesis.cancel(); }catch{} speechSynthesis.speak(u); }
const speakGuardian=(t)=>speakBase('Guardi√°n: ', t, {rate:1.02, pitch:1.15});
const speakSystem=(t)=>speakBase('', t, {rate:1.0, pitch:0.95});

// Log de errores visibles en CC
window.addEventListener('error', (e)=>{ cc('‚ö†Ô∏è JS: '+e.message); });
window.addEventListener('unhandledrejection', (e)=>{ cc('‚ö†Ô∏è Promise: '+(e.reason && e.reason.message || e.reason)); });

/********************* √Ålbum *********************/
function loadAlbum(){ try{return JSON.parse(localStorage.getItem(LS_ALBUM_KEY)||'[]')}catch{ return [] }}
function saveAlbumCard(card){ if(tutorialMode) { renderAlbum(); return; } const album=loadAlbum(); if(!album.includes(card)){ album.push(card); localStorage.setItem(LS_ALBUM_KEY, JSON.stringify(album)); } renderAlbum(); if(currentSession){ if(!currentSession.cardsGained.includes(card)) currentSession.cardsGained.push(card); }}
function renderAlbum(){ const cards=loadAlbum(); const box=document.getElementById('albumCards'); if(!box) return; box.innerHTML = cards.length? cards.map(c=>`<div class='card-know'><h4>Tarjeta</h4><p>${c}</p></div>`).join('') : '<p>No hay tarjetas a√∫n. ¬°Resuelve f√≥siles para coleccionarlas!</p>'; }

/********************* Diario *********************/
function loadDiary(){ try{return JSON.parse(localStorage.getItem(LS_DIARY_KEY)||'[]')}catch{ return [] }}
function saveDiary(session){ if(tutorialMode) { renderDiary(); return; } const d=loadDiary(); d.unshift(session); localStorage.setItem(LS_DIARY_KEY, JSON.stringify(d)); renderDiary(); }
function renderDiary(){ const d=loadDiary(); const wrap=document.getElementById('diaryWrap'); if(!wrap) return; if(!d.length){ wrap.innerHTML='<p>Sin sesiones a√∫n. ¬°Comienza una expedici√≥n!</p>'; return; }
  wrap.innerHTML = d.map((s,si)=>{
    const header=`${new Date(s.startedAt).toLocaleString()} ¬∑ ${s.reto?'Reto 90s':'Normal'} ¬∑ Tiempo: ${s.totalSeconds}s ¬∑ Pistas: ${s.totalHints} ¬∑ Correctos: ${s.correct}/${s.total}`;
    const cards=s.cardsGained.length? s.cardsGained.map(c=>`<li>${c}</li>`).join('') : '<li>‚Äî</li>';
    const rows=s.fossils.map(f=>`<tr><td>${f.titulo}</td><td>${f.intentos}</td><td>${f.pistas}</td><td>${f.respuesta}</td><td>${f.correct?'‚úÖ':'‚ùå'}</td><td>${f.reflexion||'‚Äî'}</td></tr>`).join('');
    return `<details ${si===0?'open':''}><summary>${header}</summary>
      <div style="margin:.5rem 0"><strong>Tarjetas ganadas:</strong><ul>${cards}</ul></div>
      <table><thead><tr><th>F√≥sil</th><th>Intentos</th><th>Pistas</th><th>Respuesta</th><th>Correcto</th><th>Reflexi√≥n</th></tr></thead><tbody>${rows}</tbody></table>
    </details>`;
  }).join('');
}

/********************* Utilidades *************************/
function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function iconForTypeSVG(tipo, size=56){
  const common=(body)=>`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120' width='${size}' height='${size}' role='img' aria-label='${tipo}' style='color: var(--ink)'>${body}</svg>`;
  if(tipo==='Comentario'){
    return common(`<rect x='10' y='20' rx='14' width='100' height='70' fill='var(--chip-chat)'></rect>
      <circle cx='28' cy='50' r='6' fill='currentColor'/><circle cx='48' cy='50' r='6' fill='currentColor'/><circle cx='68' cy='50' r='6' fill='currentColor'/>
      <path d='M30 90 L20 110 L48 92' fill='var(--chip-chat)'/>`);
  }
  if(tipo==='Foto'){
    return common(`<rect x='14' y='24' rx='10' width='92' height='72' fill='var(--chip-foto)'></rect>
      <circle cx='44' cy='50' r='10' fill='currentColor'/>
      <path d='M34 78 L54 58 L72 72 L86 60 L100 78 Z' fill='currentColor'/>`);
  }
  if(tipo==='Post'){
    return common(`<rect x='16' y='24' rx='10' width='88' height='72' fill='var(--chip-post)'></rect>
      <rect x='28' y='40' width='64' height='10' rx='5' fill='currentColor'/>
      <rect x='28' y='58' width='48' height='10' rx='5' fill='currentColor'/>
      <path d='M90 84 a10 10 0 1 1 -20 0 a10 10 0 1 1 20 0' fill='currentColor'/>`);
  }
  return common(`<rect x='20' y='20' rx='12' width='80' height='80' fill='var(--chip-ubi)'></rect>
    <path d='M60 36a18 18 0 0 0-18 18c0 14 18 36 18 36s18-22 18-36A18 18 0 0 0 60 36zm0 12a6 6 0 1 1 0 12 6 6 0 0 1 0-12z' fill='currentColor'/>`);
}
function microVignetteSVG(tipo){ return iconForTypeSVG(tipo, 140); }
function setEnergy(e){ energy=Math.max(0, Math.min(3, e)); const bar=document.getElementById('energyBar'); if(!bar) return; bar.innerHTML=''; for(let i=0;i<3;i++){ const b=document.createElement('span'); b.style.width='18px'; b.style.height='26px'; b.style.display='inline-block'; b.style.clipPath='polygon(45% 0, 60% 0, 40% 40%, 65% 40%, 25% 100%, 40% 60%, 15% 60%)'; b.style.background = i<energy? 'var(--accent2)' : '#6d7fb0'; b.style.border='2px solid ' + (i<energy? '#1d6b32':'#3b4a7a'); bar.appendChild(b);} }
function setTimerText(text){ const el=document.getElementById('timer'); if(el) el.textContent=text; }

/********************* Render *********************/
function renderProgress(){ const bar=document.getElementById('progressBar'); if(!bar) return; bar.innerHTML=''; orden.forEach((idx,i)=>{ const dot=document.createElement('div'); dot.className='progress-dot pending'; dot.id='dot'+i; dot.setAttribute('title', BASE_FOSILES[idx].titulo); bar.appendChild(dot); }); }
function renderGrid(){ const grid=document.getElementById('grid'); if(!grid) return; grid.innerHTML=''; orden.forEach((idx,i)=>{ const f=BASE_FOSILES[idx]; const btn=document.createElement('button'); btn.className='fossil'; btn.setAttribute('role','listitem'); btn.setAttribute('aria-label', `${f.titulo}. ${f.causa}. Abrir cronoscopio.`); btn.innerHTML=`<div class="icon" aria-hidden="true">${iconForTypeSVG(f.tipo)}</div><div><span class="chip chip--${f.tipo}">${f.tipo}</span><h3>${f.titulo}</h3><p><strong>Causa:</strong> ${f.causa}</p></div>`; btn.onclick=()=>mostrarFosil(i); grid.appendChild(btn); }); }

/********************* Inicio / Reto *********************/
function iniciar(r){ reto=!!r; if(ticker){ clearInterval(ticker); ticker=null; } bonusEstrellas=0; startedAt=Date.now(); if(reto){ tiempo=90; setTimerText(tiempo+'s'); ticker=setInterval(()=>{ tiempo--; setTimerText(tiempo+'s'); if(tiempo<=0){ clearInterval(ticker); setTimerText('0s'); finalizar(); } }, 1000);} else { setTimerText('‚Äî'); tiempo=0; }
  orden = shuffle(BASE_FOSILES.map((_,i)=>i)); intentos = Array(orden.length).fill(0); aciertos=0; current=null; setEnergy(3); renderProgress(); renderGrid(); document.getElementById('diplomaSection').style.display='none'; document.getElementById('chrono').style.display='none';
  // preparar sesi√≥n
  currentSession={ startedAt, reto, order:[...orden], fossils: orden.map(idx=>({ id:BASE_FOSILES[idx].id, titulo:BASE_FOSILES[idx].titulo, intentos:0, pistas:0, respuesta:'', correct:false, reflexion:'' })), cardsGained:[] };
  if(!tutorialMode) speakGuardian('Bienvenido, Arque√≥logo del Tiempo Digital. Examina los f√≥siles y activa el Cronoscopio.');
}

/********************* Cronoscopio + Focus Trap *********************/
let trapPrevFocus=null;
function mostrarFosil(i){ current=i; const f=BASE_FOSILES[orden[i]]; const chrono=document.getElementById('chrono'); if(!chrono) return; chrono.classList.add('active'); chrono.style.display='block'; document.getElementById('cTitle').textContent=f.titulo; document.getElementById('cCause').textContent='Causa: '+f.causa; document.getElementById('cDesc').textContent='Consecuencia: '+f.consecuencia; document.getElementById('cIcon').innerHTML=microVignetteSVG(f.tipo); document.getElementById('status').textContent='Elige si esta huella es positiva o negativa.'; trapPrevFocus=document.activeElement; const first=document.getElementById('btnPos'); if(first) first.focus(); if(!tutorialMode) speakGuardian('Observa la visi√≥n del futuro. ¬øEs una huella positiva o negativa? Usa flechas y Enter.'); }
function trapKeydown(e){ const chrono=document.getElementById('chrono'); if(!chrono || !chrono.classList.contains('active')) return; const pos=document.getElementById('btnPos'); const neg=document.getElementById('btnNeg'); if(e.key==='Tab'){ e.preventDefault(); (document.activeElement===pos?neg:pos).focus(); } if(e.key==='Escape'){ cerrarCrono(); } if(e.key==='ArrowLeft'){ pos.focus(); } if(e.key==='ArrowRight'){ neg.focus(); } if(e.key==='Enter'){ if(document.activeElement===pos) clasificar('positivo'); if(document.activeElement===neg) clasificar('negativo'); } }
document.addEventListener('keydown', trapKeydown);

/********************* Clasificaci√≥n + Pistas + Reflexi√≥n *********************/
function clasificar(resp){ if(current==null) return; const f=BASE_FOSILES[orden[current]]; const correcto = resp===f.correcta; const dot=document.getElementById('dot'+current); const foss=currentSession? currentSession.fossils[current] : null; if(foss) foss.respuesta=resp;
  if(correcto){ if(foss) foss.correct=true; aciertos++; if(dot) dot.className='progress-dot correct'; if(!tutorialMode) saveAlbumCard(f.card); if(reto && tiempo>20) bonusEstrellas = Math.min(3, 1 + Math.floor((tiempo-20)/20)); setEnergy(Math.min(3, energy+1)); speakSystem('¬°An√°lisis correcto! Has conectado la causa con su efecto.');
    if(tutorialMode){ reflexionRapida((seleccion)=>{ if(foss) foss.reflexion=seleccion; cerrarCrono(); }); }
    else { reflexionRapida((seleccion)=>{ if(foss) foss.reflexion=seleccion; cerrarCrono(); if(aciertos===orden.length) finalizar(); }); }
  } else { if(foss){ intentos[current]++; foss.intentos=intentos[current]; foss.pistas=Math.min(f.pistas.length, intentos[current]); }
    if(dot) dot.className='progress-dot retry'; setEnergy(energy-1); const paso = Math.min(intentos[current], f.pistas.length) - 1; const pistaTxt = f.pistas[paso] || 'Observa si la consecuencia protege o arriesga la privacidad.'; document.getElementById('status').innerHTML='‚ùå Pi√©nsalo de nuevo.<br><small>'+pistaTxt+'</small>'; speakSystem('Pi√©nsalo de nuevo. '+pistaTxt); try{ if(!narrationOn && navigator.vibrate) navigator.vibrate([30,50]); }catch{} }
}
function cerrarCrono(){ const chrono=document.getElementById('chrono'); if(!chrono) return; chrono.classList.remove('active'); chrono.style.display='none'; if(trapPrevFocus){ try{ trapPrevFocus.focus(); }catch{} trapPrevFocus=null; } current=null; }

function finalizar(){ if(ticker){ clearInterval(ticker); ticker=null; } if(tutorialMode){ speakGuardian('Fin del tutorial. ¬°Ahora intenta jugar por tu cuenta!'); endTutorial(true); return; } const finishedAt=Date.now(); const totalSeconds = reto? (90 - tiempo) : Math.round((finishedAt - startedAt)/1000); const totalHints = currentSession.fossils.reduce((a,b)=>a+(b.pistas||0),0); currentSession.finishedAt=finishedAt; currentSession.totalSeconds=totalSeconds; currentSession.totalHints=totalHints; currentSession.correct=aciertos; currentSession.total=orden.length; saveDiary(currentSession); speakGuardian('¬°Misi√≥n cumplida! Has obtenido el t√≠tulo de Arque√≥logo de la Sabidur√≠a.'); mostrarDiploma(); }

/********************* Reflexi√≥n breve *********************/
function reflexionRapida(onClose){ const f=BASE_FOSILES[orden[current]]; const status=document.getElementById('status'); const opciones = (
  f.id==='comentario' ? ['Pedir disculpas y apoyar a Leo','No escribir cuando est√°s enojado'] :
  f.id==='foto' ? ['Pedir permiso antes de publicar','Mantener fotos privadas si pueden avergonzar'] :
  f.id==='post' ? ['Agradecer en p√∫blico con respeto','Escribir una nota privada de agradecimiento'] :
  ['Compartir ubicaci√≥n despu√©s (no en tiempo real)','Enviar lugar por mensaje privado a amigos']
);
  status.innerHTML = `<div class='panel' style='margin-top:.5rem; color: var(--ink)'><strong>Reflexi√≥n:</strong> ¬øQu√© habr√≠a sido una mejor alternativa?<br>
    <div style='display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.5rem'>
      <button class='choice positive' style='min-width:180px' id='optA'>${opciones[0]}</button>
      <button class='choice negative' style='min-width:180px' id='optB'>${opciones[1]}</button>
    </div></div>`;
  if(!tutorialMode) speakGuardian('Reflexiona: elige una mejor alternativa.');
  const save=(sel)=>{ if(!tutorialMode){ const album=loadAlbum(); album.push('Reflexi√≥n - '+f.titulo+': '+sel); localStorage.setItem(LS_ALBUM_KEY, JSON.stringify(album)); renderAlbum(); } if(onClose) onClose(sel); };
  document.getElementById('optA').onclick=()=>save(opciones[0]);
  document.getElementById('optB').onclick=()=>save(opciones[1]);
}

/********************* Diploma *********************/
function drawStar(ctx, x, y, r, n, inset, color){ ctx.save(); ctx.fillStyle=color; ctx.beginPath(); ctx.translate(x, y); ctx.moveTo(0,0-r); for(let i=0;i<n;i++){ ctx.rotate(Math.PI / n); ctx.lineTo(0, 0 - (r/inset)); ctx.rotate(Math.PI / n); ctx.lineTo(0, 0 - r); } ctx.fill(); ctx.restore(); }
function mostrarDiploma(){ const section=document.getElementById('diplomaSection'); section.style.display='block'; const canvas=document.getElementById('diplomaCanvas'); const ctx=canvas.getContext('2d'); const css=getComputedStyle(document.body); const cInk=(css.getPropertyValue('--ink')||'#222').trim(); const cCard=(css.getPropertyValue('--card')||'#fff8e1').trim(); const cGold=(css.getPropertyValue('--gold')||'#fbc02d').trim(); ctx.fillStyle=cCard; ctx.fillRect(0,0,canvas.width,canvas.height); ctx.strokeStyle=cGold; ctx.lineWidth=12; ctx.strokeRect(24,24,canvas.width-48,canvas.height-48); ctx.fillStyle=cInk; ctx.font='bold 40px Arial'; ctx.fillText('Diploma: Arque√≥logo/a de la Sabidur√≠a', 60, 130); ctx.font='22px Arial'; ctx.fillText('Por clasificar correctamente los 4 f√≥siles digitales', 60, 175); const stars = reto && tiempo>20 ? Math.min(3, 1 + Math.floor((tiempo-20)/20)) : 0; for(let i=0;i<stars;i++){ drawStar(ctx, 60 + i*40, 210, 14, 5, 2, cGold); } const cx=760, cy=150; ctx.fillStyle='#ffd54f'; ctx.beginPath(); ctx.arc(cx, cy, 56, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#f57f17'; ctx.beginPath(); ctx.moveTo(cx-34, cy+10); ctx.lineTo(cx-56, cy+112); ctx.lineTo(cx-14, cy+112); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.moveTo(cx+34, cy+10); ctx.lineTo(cx+12, cy+112); ctx.lineTo(cx+56, cy+112); ctx.closePath(); ctx.fill(); ctx.fillStyle='#5d4037'; ctx.font='bold 30px Arial'; ctx.fillText('üèÜ', cx-18, cy+14); const date=new Date().toLocaleDateString(); ctx.fillStyle=(css.getPropertyValue('--muted')||'#555').trim(); ctx.font='20px Arial'; ctx.fillText('Fecha: '+date, 60, 245); }

/********************* Eventos UI *********************/
 document.getElementById('btnPos').onclick=()=>clasificar('positivo');
 document.getElementById('btnNeg').onclick=()=>clasificar('negativo');
 document.getElementById('startBtn').onclick=()=>{ tutorialMode=false; iniciar(reto); };
 document.getElementById('challengeToggle').onclick=(e)=>{ reto=!reto; e.currentTarget.setAttribute('aria-pressed', reto); e.currentTarget.textContent = reto? '‚è±Ô∏è Modo Reto ON' : '‚è±Ô∏è Modo Reto'; };
 document.getElementById('themeToggle').onclick=(e)=>{ document.body.classList.toggle('solar-theme'); e.currentTarget.setAttribute('aria-pressed', document.body.classList.contains('solar-theme')); };
 document.getElementById('downloadDiploma').onclick=()=>{ const canvas=document.getElementById('diplomaCanvas'); const link=document.createElement('a'); link.download='diploma.png'; link.href=canvas.toDataURL('image/png'); link.click(); };
 document.getElementById('narrationToggle').onchange=(e)=>{ narrationOn = e.target.checked; if(!narrationOn){ try{ speechSynthesis.cancel(); }catch{} cc('Voz en off desactivada. Se usar√° vibraci√≥n como feedback.'); } else { cc('Voz en off activada.'); } };

/********************* Tutorial: l√≥gica *********************/
const tutOverlay=document.getElementById('tutOverlay'); const tutDesc=document.getElementById('tutDesc'); const tutTitle=document.getElementById('tutTitle');
const tutNext=document.getElementById('tutNext'); const tutPrev=document.getElementById('tutPrev'); const tutSkip=document.getElementById('tutSkip');

const TSTEPS=[
 {title:'Bienvenida', selector:null, text:'Soy el Guardi√°n. Te ense√±ar√© a usar el Cronoscopio y a clasificar huellas digitales. Ver√°s cada herramienta con un ejemplo.', action:()=>{ speakGuardian('Bienvenido al tutorial. Ver√°s cada herramienta y un ejemplo.'); }},
 {title:'Progreso por f√≥sil', selector:'#progressBar', text:'Estos puntos muestran tu progreso. Verde = correcto, Rojo = reintento.', action:()=>{}},
 {title:'F√≥siles digitales', selector:'#grid', text:'Aqu√≠ tienes los 4 f√≥siles. Haz clic en uno para activar el Cronoscopio. Yo lo har√© por ti.', action:()=>{ if(!orden.length) iniciar(false); const btn = document.querySelector('#grid .fossil'); if(btn){ btn.classList.add('highlight-ring'); setTimeout(()=>{ btn.click(); }, 700); } }},
 {title:'Cronoscopio', selector:'#chrono', text:'Aqu√≠ ves la causa y la consecuencia futura. Decide si la huella es positiva o negativa.', action:()=>{ speakGuardian('Observa la visi√≥n y decide.'); }},
 {title:'Clasificaci√≥n', selector:'#chrono .choices', text:'Vamos a elegir una opci√≥n de ejemplo para ver el feedback.', action:()=>{ const f=BASE_FOSILES[orden[current]]; const btn = f.correcta==='positivo'? document.getElementById('btnPos') : document.getElementById('btnNeg'); setTimeout(()=>{ if(btn){ btn.classList.add('highlight-ring'); btn.focus(); setTimeout(()=>btn.click(), 900); } }, 500); }},
 {title:'Pistas', selector:'#status', text:'Si te equivocas, ver√°s pistas escalonadas. En el tutorial no se guardan intentos reales.', action:()=>{}},
 {title:'Energ√≠a', selector:'#energyBar', text:'Cada error consume ‚ö° y cada acierto recarga. Solo es visual, no pierdes la partida.', action:()=>{}},
 {title:'Modo Reto', selector:'#challengeToggle', text:'Puedes activar un reto de 90 segundos. Ganas estrellas si terminas con tiempo de sobra.', action:()=>{}},
 {title:'√Ålbum', selector:'#albumSection', text:'Cada acierto otorga una tarjeta de conocimiento. Aqu√≠ las ver√°s y podr√°s repasarlas.', action:()=>{}},
 {title:'Diario', selector:'#diarySection', text:'El Diario guarda evidencia de aprendizaje por partida: tiempo, pistas e intentos.', action:()=>{}},
 {title:'Diploma', selector:'#diplomaSection', text:'Al completar todos los f√≥siles, obtienes un diploma descargable.', action:()=>{}},
 {title:'¬°Listo!', selector:null, text:'Terminamos el tutorial. ¬°Ahora juega una partida real! (Nada de esto se guard√≥).', action:()=>{}}
];

function highlight(sel){ document.querySelectorAll('.highlight-ring').forEach(el=>el.classList.remove('highlight-ring')); if(!sel) return; const el=document.querySelector(sel); if(el){ el.classList.add('highlight-ring'); el.scrollIntoView({behavior:'smooth', block:'center'}); } }
function showStep(i){ tutorialStep=i; const step=TSTEPS[i]; tutTitle.textContent='üß≠ '+step.title; tutDesc.textContent=step.text; highlight(step.selector); if(step.action) step.action(); tutPrev.disabled = (i===0); tutNext.textContent = (i===TSTEPS.length-1)? 'Finalizar' : 'Siguiente ‚Üí'; }
function startTutorial(){ tutorialMode=true; iniciar(false); setTimeout(()=>{ tutOverlay.classList.add('active'); tutOverlay.focus(); showStep(0); }, 60); }
function endTutorial(restart){ tutorialMode=false; tutOverlay.classList.remove('active'); document.querySelectorAll('.highlight-ring').forEach(el=>el.classList.remove('highlight-ring')); if(restart){ iniciar(false); } }

tutNext.onclick=()=>{ if(tutorialStep < TSTEPS.length-1){ showStep(tutorialStep+1); } else { endTutorial(true); } };
 tutPrev.onclick=()=>{ if(tutorialStep>0) showStep(tutorialStep-1); };
 tutSkip.onclick=()=> endTutorial(true);
 document.getElementById('tutorialBtn').onclick=()=> startTutorial();

/********************* Aliases API m√≠nima solicitada *********************/
function iniciarJuego(){ iniciar(false); }
function mostrarConsecuencia(id){ mostrarFosil(id); }
function feedback(correcto){ if(correcto) speakSystem('¬°An√°lisis correcto!'); else speakSystem('Int√©ntalo otra vez.'); }

/********************* Inicial *********************/
setEnergy(3); renderAlbum(); renderDiary(); orden = BASE_FOSILES.map((_,i)=>i); renderProgress(); renderGrid(); cc('Guardi√°n: Bienvenido a Ecos del Futuro. Pulsa Comenzar expedici√≥n.');

/********************* Service Worker simple para OFFLINE *********************/
if('serviceWorker' in navigator){ const swCode=`const C='ecos-v3'; self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll([self.registration.scope])).then(()=>self.skipWaiting()))}); self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())}); self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request,{ignoreSearch:true}).then(r=>r||fetch(e.request).then(res=>{const cp=res.clone(); caches.open(C).then(c=>c.put(e.request,cp)); return res;}).catch(()=>r)))})`; const blob=new Blob([swCode],{type:'text/javascript'}); const url=URL.createObjectURL(blob); navigator.serviceWorker.register(url).catch(()=>{}); }
</script>
</body>
</html>
